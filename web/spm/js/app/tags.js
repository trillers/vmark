module.exports=function(){riot.tag("note-comment",'<div class="feature_area"> <div> <div class="txt_area"> <input oninput="{noteEditInput}" name="txtInput" placeholder="点击输入文字" value=""> </div> <div class="toggle_menu"> <div onclick="{addComment}" class="send_btn" if="{viewModel.input.editTxt}">发送</div> </div> </div> <div style="clear: both"></div> </div>',"note-comment .feature_area{ height: 48px; background: white; width: 100%; overflow: hidden; } note-comment .feature_area >div{ overflow: hidden; margin-top: 8px; } note-comment .feature_area >div >div{ height: 32px; float:left; } note-comment .feature_area .toggle_txt_voi{ width:15%; } note-comment .feature_area .txt_area{ width: 70%; } note-comment .feature_area .voi_area{ width: 70%; } note-comment .feature_area .voi_area input{ width: 100%; height: 32px; box-sizing: border-box; border: 1px solid #ccc; font-size: 16px; border-radius: 5px; text-align: center; color: #ccc; } note-comment .feature_area .txt_area input{ width: 100%; height: 32px; box-sizing: border-box; border: none; border-bottom: 1px solid #ccc; font-size: 16px; } note-comment .feature_area .toggle_menu{ width: 15%; } note-comment .feature_area .send_btn{ margin: 0px auto; width: 60px; height: 32px; line-height: 32px; border: 1px solid #ccc; box-sizing:border-box; border-radius: 5px; background: #18c54b; border: none; text-align: center; color: white; } note-comment .feature_area .toggle_btn{ margin: 0px auto; width: 32px; height: 32px; border-radius: 50em; border: 1px solid #ccc; box-sizing:border-box; }",function(t){var e=this,o=domain.action("saveComment");e.viewModel={input:{wait:!0,editTxt:!1,doWait:function(){this.wait=!0,this.editTxt=!1},doEdit:function(){this.wait=!1,this.editTxt=!0}}},e.addComment=function(t){""!==e.txtInput.value.trim()&&o.newInvocation({note:e.parent.currComment._id,interaction:{initiator:e.parent.user._id,content:e.txtInput.value.trim()}}).onDone(function(t){e.txtInput.value="",e.viewModel.input.doWait(),console.error(t.comment),e.parent.trigger("noteComment",t.comment)}).execute()},e.noteEditInput=function(t){var o=t.currentTarget.value.trim();o?e.viewModel.input.doEdit():e.viewModel.input.doWait()}});
riot.tag("note-confirm",'<div class="weui_dialog_confirm" id="dialog1" if="{show}"> <div class="weui_mask"></div> <div class="weui_dialog"> <div class="weui_dialog_hd"><strong class="weui_dialog_title">是否删除评论</strong></div> <div class="weui_dialog_ft"> <a onclick="{cancel}" class="weui_btn_dialog default">取消</a> <a onclick="{confirm}" class="weui_btn_dialog primary">确定</a> </div> </div> </div>',function(i){var a=this;a.show=!1,a.currTag=null,a.on("popUp",function(){a.show=!0,a.update()}),a.confirm=function(i){a.trigger("confirm"),a.show=!1},a.cancel=function(i){a.trigger("cancel"),a.show=!1}});
riot.tag("note-edit",'<div class="page"> <div class="title" if="{false}"> <input class="input" onblur="{updatePageNote}" type="text" value="{pageNote.title}" placeholder="添加标题" name="titleInput"> <div class="reference"> <img class="user-icon" riot-src="{user.headimgurl}"> <label class="user-icon"> {user.nickname}</label> <span> 创建于{formatDate(new Date())}</span> </div> <hr class="line" style="margin-bottom: 10px"> </div> <div> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <button onclick="{goToAuthorize}">去授权</button> </div> <div> <note-section each="{item in pageNote.mates}" if="{item.status != \'dr\'}" section="{item}"></note-section> <note-section if="{currNote === newSection}" section="{newSection}" new="true"></note-section> </div> <ul class="btn-group" onclick="{selectOperate}"> <li><a class="weui_btn weui_btn_mini weui_btn_primary">文字</a></li> <li><a class="weui_btn weui_btn_mini weui_btn_primary">图片</a></li> <li><a class="weui_btn weui_btn_mini weui_btn_primary">语音</a></li> <li><a class="weui_btn weui_btn_mini weui_btn_primary">小视频</a></li> </ul> <div> <span if="{pageNote.parentNote}">{pageNote.txt}</span> </div> <div style="clear: both"></div> </div> <note-confirm></note-confirm> <note-footer if="{Object.keys(currNote).length}"></note-footer> <note-comment if="{currComment}"></note-comment>',"note-edit :focus{ outline: none; } note-edit .title-input1{ font-size: 16px; display: inline-block; height:30px; line-height: 30px; background: transparent; border: none; } note-edit .note_items div{ height: 40px; line-height: 40px; } note-edit body{ font-size: 14px; } note-edit .btn-group{ list-style-type: none; } note-edit .btn-group li{ float:left; padding:10px; }",function(e){"use strict";var t=nest.presentable(this),n=window.location.href,o=domain.action("loadNote"),i=domain.action("updateNote"),a=function(e){e.error?alert(e.error.message):util.mixin(t.pageNote,e)},r=function(e){if(e&&(t.pageNote=e,t.pageNote.mates&&t.pageNote.mates.length)){var n=t.pageNote.mates.filter(function(e){return"dr"===e.status?e:void 0});n&&n.length&&(t.pageNote.mates=util.arr.rest(t.pageNote.mates,n),t.newSection=n[0],t.selectNote(t.newSection))}t.trigger("ready",!1),t.trigger("view-route-to"),t.update()};t.pageNote=null,t.newSection={},t.newSection.mates=[],t.currNote={},t.currComment=null,t.user=__page.user,t.user.headimgurl=t.user.headimgurl||"/public/images/def-avatar.png",t.formatDate=function(e){return new Date(e).toLocaleString()},t.formatDateForMates=util.formatDateForComments,t.init=function(){t.pageNote={title:null,comments:null,crtOn:null,_id:null},t.titleInput.value="",wx.onMenuShareTimeline({title:t.pageNote.title||__app.resources.app.title,link:n,imgUrl:__page.baseUrl+"/public/images/logo_share_48x48.jpg",success:function(){},cancel:function(){}}),wx.onMenuShareAppMessage({title:t.pageNote.title||__app.resources.app.title,desc:"",link:n,imgUrl:__page.baseUrl+"/public/images/logo_share_48x48.jpg",success:function(){},cancel:function(){}})},t.on("cancel",function(e){t.currNote=null,t.update()}),t.on("comment",function(e){t.currComment=e,t.currNote=null,t.update()}),t.on("noteComment",function(e){t.currComment.comments.push(e),t.update()}),t.updatePageNote=function(e){var n=e.currentTarget.value;n&&i.execute({id:t.pageNote._id,title:n})},t.selectNote=function(e,n){t.currNote=e,t.currComment=null,t.update()},t.selectOperate=function(e){if("A"===e.target.nodeName){e.target;t.selectNote(t.newSection)}},t.on("noteSubmit",function(){t.currNote=null,t.newSection={},t.newSection.mates=[],t.update()}),t.on("noteSave",function(){t.update()}),t.on("active",function(e){t.selectNote(e.section,e)}),t.on("mount",function(){o.onDone(r),i.onDone(a)}),t.on("unmount",function(){o.offDone(r),i.onDone(a)}),t.on("open",function(e){t.init();try{t.pageNote._id=window.location.pathname.match(/_(\w+)/g)[0].substr(1)}catch(n){alert("无效的链接")}console.info("tag pageNote new is opening"),o.execute({noteId:t.pageNote._id})}),t.on("leave",function(){t.mask=!0,t.update()}),t.on("reenter",function(){t.mask=!1,t.update()}),t.on("refresh",function(){console.info("tag group index is refreshing")}),this.goToAuthorize=function(e){var t="/auth/authorize?";t+="route=get_user_info&returnUrl="+location.href,location.href=t}.bind(this)});
riot.tag("note-footer",'<div class="record_detail_area"> <div class="record-el-container"> <div class="record_progress_bar"> <div class="record_progress_inner_bar js_progress" style="width: 0%;"></div> </div> <div class="voice-seconds-container" style="color: white"> <span id="voice-seconds">0</span>" </div> <div class="recording-gif voi_area-el"> <img src="/public/images/def-avatar.png" style="width: 30px; height: 60px" alt=""> </div> <div class="voice-func-btn voi_area-el"> <div id="stop-record" onclick="{stopRecord}"></div> <div id="play-record" onclick="{playRecord}"></div> <div id="pause-record" onclick="{pauseRecord}"></div> </div> <div class="voice-confirm-area voi_area-el"> <div id="confirm-sub-voice" class="weui_icon_success_no_circle" onclick="{confirmSubVoice}"></div> </div> </div> </div> <div class="feature_area"> <div> <div class="toggle_txt_voi"> <div onclick="{viewModel.toggleTxtVoiBtn.toggle}" class="toggle_btn"></div> </div> <div if="{viewModel.toggleTxtVoiBtn.txt}" class="txt_area"> <input oninput="{noteEditInput}" name="txtInput" placeholder="点击输入文字" value=""> </div> <div if="{viewModel.toggleTxtVoiBtn.voi}" class="voi_area" ontouchstart="{voiceAreaTouchStart}" ontouchend="{voiceAreaTouchEnd}"> <input type="button" value="长按录音"> </div> <div class="toggle_menu"> <div onclick="{toggleSubMenu}" class="toggle_btn menu_btn" if="{viewModel.input.wait}">菜单</div> <div onclick="{addTxt}" class="send_btn" if="{viewModel.input.editTxt}">发送</div> </div> </div> <div style="clear: both"></div> </div> <div if="{viewModel.subMenu.showState}" class="scale_area"> <ul> <li class="img_btn" onclick="{addImgs}">图片</li> <li class="video_btn">视频</li> </ul> </div>',"note-footer .record_progress_bar { margin-top: 10px; background-color: #EBEBEB; height: 3px; -webkit-box-flex: 1; -webkit-flex: 1; -ms-flex: 1; flex: 1; } note-footer .record_progress_inner_bar { width: 0; height: 100%; background-color: #09BB07; } note-footer .record_detail_area{ -webkit-user-select: none; display: none; position: absolute; float: left; bottom: 0px; width: 100%; height: 140px; background-color: rgba(51, 51, 51, 0.5); z-index: 999; } note-footer .scale_area{ height: 96px; border-top: 1px solid #ccc; background: white; } note-footer .scale_area ul{ width: 80%; list-style-type: none; margin: 0px auto; padding: 0px; margin-top: 28px; overflow: hidden; } note-footer .scale_area ul li{ float: left; margin-left: 10%; width: 40px; height: 40px; border: 1px solid #ccc; } note-footer .scale_area ul li:first-child{ float: left; margin-left: 0px; } note-footer .scale_area .img_btn{ } note-footer .feature_area{ height: 48px; background: white; width: 100%; overflow: hidden; } note-footer .feature_area >div{ overflow: hidden; margin-top: 8px; } note-footer .feature_area >div >div{ height: 32px; float:left; } note-footer .feature_area .toggle_txt_voi{ width:15%; } note-footer .feature_area .txt_area{ width: 70%; } note-footer .feature_area .voi_area{ width: 70%; } note-footer .feature_area .voi_area input{ width: 100%; height: 32px; box-sizing: border-box; border: 1px solid #ccc; font-size: 16px; border-radius: 5px; text-align: center; color: #ccc; } note-footer .feature_area .txt_area input{ width: 100%; height: 32px; box-sizing: border-box; border: none; border-bottom: 1px solid #ccc; font-size: 16px; } note-footer .feature_area .toggle_menu{ width: 15%; } note-footer .feature_area .send_btn{ margin: 0px auto; width: 60px; height: 32px; line-height: 32px; border: 1px solid #ccc; box-sizing:border-box; border-radius: 5px; background: #18c54b; border: none; text-align: center; color: white; } note-footer .feature_area .toggle_btn{ margin: 0px auto; width: 32px; height: 32px; border-radius: 50em; border: 1px solid #ccc; box-sizing:border-box; } note-footer .feature_area .scale_area{ height: 48px; } note-footer .voi_area-el{ margin-top: 5px; float: left; margin-left: 40px; } note-footer .record-el-container{ width: 80%; margin: 0 auto; } note-footer #stop-record{ background: url(/web/images/stop-active.png); width: 72px; height: 72px; background-color: white; border-radius: 40px; } note-footer #play-record{ display: none; background: url(/web/images/start-active.png); width: 72px; height: 72px; background-color: white; border-radius: 40px; } note-footer #pause-record{ display: none; background: url(/web/images/start-active.png); width: 72px; height: 72px; background-color: white; border-radius: 40px; } note-footer #confirm-sub-voice{ display: none; } note-footer #confirm-sub-voice::before{ font-size: 45px; }",function(e){var o=this,t=domain.action("saveNotesInSection"),i=domain.action("saveNoteInSection");o.viewModel={toggleTxtVoiBtn:{txt:!0,voi:!1,toggle:function(){var e=o.viewModel.toggleTxtVoiBtn;e.txt=!e.txt,e.voi=!e.voi}},subMenu:{showState:!1,toggle:function(){var e=o.viewModel.subMenu;e.showState=!e.showState},show:function(){var e=o.viewModel.subMenu;e.showState=!0},hide:function(){var e=o.viewModel.subMenu;e.showState=!1}},input:{wait:!0,editTxt:!1,doWait:function(){this.wait=!0,this.editTxt=!1},doEdit:function(){this.wait=!1,this.editTxt=!0}}},o.addTxt=function(e){""!==o.txtInput.value.trim()&&i.newInvocation({type:"txt",content:o.txtInput.value.trim(),parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id}).onDone(function(e){util.mixin(o.parent.currNote,e.sectionNote),o.parent.currNote.mates.push(e.note),o.txtInput.value="",o.viewModel.input.doWait(),o.parent.trigger("noteSave",e.note)}).execute()},o.addImgs=function(e){wx.chooseImage({count:9,sizeType:["compressed"],sourceType:["album","camera"],success:function(e){var i=e.localIds.map(function(e){return{type:"img",url:e,parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id}});t.newInvocation({notes:i}).onDone(function(e){e?(o.parent.currNote.mates||(o.parent.currNote.mates=[]),e.parentNote&&util.mixin(o.parent.currNote,e.parentNote),o.parent.currNote.mates=o.parent.currNote.mates.concat(e.mates),o.parent.trigger("noteSave",e)):alert("error occur.")}).execute()}})},o.noteEditInput=function(e){var t=e.currentTarget.value.trim();t?o.viewModel.input.doEdit():o.viewModel.input.doWait()},o.toggleSubMenu=function(e){o.viewModel.subMenu.toggle()};var r,a,n,c={},d=!1;wx.ready(function(){console.log("ready"),wx.onVoiceRecordEnd({complete:function(e){console.error("end"),n=(new Date).getTime(),$("#stop-record").hide(),$("#play-record").show(),$("#confirm-sub-voice").show();var o=e.localId;c.localId=o}}),wx.onVoicePlayEnd({success:function(e){e.localId}})}),o.voiceAreaTouchStart=function(e){console.error("startRecord"),a=(new Date).getTime(),r=setTimeout(function(){function e(){t.css({width:o+"%"}),i.css({"padding-left":o+"%"}),$("#voice-seconds").text(r.toFixed(0)),o+=.05,r+=.03,100>o?d||setTimeout(e,30):(t.css({width:"100%"}),i.css({"padding-left":"100%"}),$("#voice-seconds").text(60))}wx.startRecord(),$(".record_detail_area").show();var o=0,t=$(".js_progress"),i=$(".voice-seconds-container"),r=0;e()},300)},o.voiceAreaTouchEnd=function(e){console.error("touchend"),n=(new Date).getTime(),300>n-a&&(n=0,a=0,clearTimeout(r))},o.stopRecord=function(e){d=!0,n=(new Date).getTime(),wx.stopRecord({success:function(e){console.log(e),$("#stop-record").hide(),$("#play-record").show(),$("#confirm-sub-voice").show();var o=e.localId;c.localId=o}})},o.playRecord=function(e){wx.playVoice({localId:c.localId}),$("#play-record").hide(),$("#pause-record").show()},o.pauseRecord=function(e){wx.pauseVoice({localId:c.localId}),$("#pause-record").hide(),$("#play-record").show()},o.confirmSubVoice=function(e){$(".record_detail_area").hide();var t=((n-a)/1e3).toFixed(0);a=0,n=0,$(".js_progress").css({width:"0%"}),$(".voice-seconds-container").css({"padding-left":"0%"}),$("#voice-seconds").text(0),d=!1,$("#stop-record").show(),$("#play-record").hide(),$("#confirm-sub-voice").hide(),$("#pause-record").hide();var r={type:"voi",url:c.localId,seconds:t,parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id};wx.pauseVoice({localId:c.localId}),i.newInvocation(r).onDone(function(e){e?(util.mixin(o.parent.currNote,e.sectionNote),o.parent.currNote.mates.push(e.note),o.parent.trigger("noteSave",e.note)):alert("error occur.")}).execute()}});
riot.tag("note-menu","<div>头部</div>","note-menu div{ height: 30px; line-height: 30px; background: #989898; text-align: center; color: white; }",function(e){});
riot.tag("note-section",'<div class="note_section1 section" sectionid="{_id}"> <div class="author" > <img class="user-icon" riot-src="{initiator.headimgurl}">&nbsp&nbsp <label class="user-nickname"> {initiator.nickname}</label> &nbsp <span style="font-size: 12px;color:#888" if="{section.parentNote && section.status != \'dr\'}">{formatDate(new Date(section.crtOn))}</span> </div> <div class="top" > <input onclick="{submitSectionNote}" if="{isOnEdit() && (initiator._id === parent.user._id)}" value="提交" type="button" class="send_btn weui_btn weui_btn_mini weui_btn_primary"> <input onclick="{cancelSectionNote}" if="{isOnEdit() && (initiator._id === parent.user._id)}" value="取消" type="button" class="send_btn weui_btn weui_btn_mini weui_btn_primary"> <input onclick="{clearTrash}" if="{isOnEdit() && trash.length>0}" value="删除" type="button" class="send_btn weui_btn weui_btn_mini weui_btn_warn"/> <input onclick="{editSectionNote}" if="{!isOnEdit() && (initiator._id === parent.user._id)}" value="编辑" type="button" class="weui_btn weui_btn_mini weui_btn_primary"> </div> <div class="noteItems"> <div each="{section.mates}" noteid="{_id}" style="margin-top: 2px"> <div onclick="{parent.pushToTrash}" if="{parent.isOnEdit()}" style="float: left"> <b class="{weui_icon_cancel : parent.inTrash(_id), weui_icon_circle: !parent.inTrash(_id)}"></b> </div> <div if="{type===\'txt\'}" class="note_txt">{content}</div> <div if="{type===\'img\'}" class="note_img"><img style="width: 100%" riot-src="{url}"></div> <div if="{type===\'voi\'}" class="note_voi" style="float:left"><div riot-style="width: {seconds * 3 + 30}px" class="voice" onclick="{parent.playVoice}"><i class="playIcon"></i></div><span class="seconds">{seconds}"</span></div> <div style="clear: both;"></div> </div> </div> <div style="position:absolute;top:0;left:0;width:0;height:0;"> <audio id="voiceMsgPlayer" class="voicePlayer"></audio> </div> <div class="bottom"> <div class="left" > <input value="+" type="button" class="weui_btn weui_btn_mini weui_btn_primary"> </div> <div class="right" if="{!isNew}"> <input onclick="{like}" value="赞" type="button" class="weui_btn weui_btn_mini weui_btn_primary"> <ul> <li each="{section.likes}" style="width: 32px;height:32px"><img style="width: 100%" riot-src="{initiator.headimgurl}"></li> </ul> <label>{section.likes.length || 0}</label> <input onclick="{comment}" value="评" type="button" class="weui_btn weui_btn_mini weui_btn_primary"> <label>{section.comments.length || 0}</label> <div class="comments" if="{parent.currComment._id === section._id}"> <ul> <li each="{section.comments}" onclick="{parent.deleteComment}"> <img class="user-icon" riot-src="{initiator.headimgurl}"> <span>{content}</span> <span style="font-size: 12px; float:right">{parent.formatDate(new Date(crtOn))}</span> </li> </ul> </div> </div> </div> </div>',"note-section label{ font-size: 14px; } note-section .interact_box{ line-height: 40px; border-top: 1px solid #ddd; } note-section .interact_box .comments img{ width: 32px; height: 32px; border: none; border-radius: 50em; vertical-align: middle; } note-section .interact_box .comments span{ margin-left: 8px; font-size: 14px; color: #888; } note-section .interact_box .comments ul{ margin: 0px; padding: 0px; list-style-type: none; } note-section .interact_box .comments ul li{ height: 48px; line-height: 48px; border-bottom: 1px solid #eee; } note-section .interact_box .comments ul li:last-child{ border-bottom: none; } note-section .noteItems div{ line-height: 31px; } note-section .noteItems div .note_img{ width:100%; } note-section .note_section{ width: 94%; border: 1px solid #ddd; margin: 15px auto; background: white; padding: 10px; padding-bottom: 0px; font-size: 14px; } note-section .note_section .featureArea{ margin-top: 10px; position: relative; } note-section .note_section .featureArea .send_btn{ display: block; float: right; height: 32px; } note-section .note_section textarea{ height: 32px; line-height: 32px; position: absolute; bottom: 2px; margin: 0px auto; left: 50px; display: block; width: -webkit-calc(100% - 100px); width: -moz-calc(100% - 100px); width: calc(100% - 100px); border: none; border-bottom: 1px solid #18c54b; font-size: 14px; } note-section .voice{ float: left; background-color: #04BE02; border-radius: 7px; } note-section .seconds{ float: left; font-size: 12px; margin-left: 5px; } note-section .playIcon{ background: url('/web/images/wx-icon.png') 0 -2428px; background-size: 150px 2489px; width: 23px; height: 23px; vertical-align: middle; display: inline-block; }",function(t){var i=this,e=(domain.action("saveNoteInSection"),domain.action("updateNote"),domain.action("deleteNotes")),n=domain.action("publishNote"),o=(domain.action("saveNotesInSection"),domain.action("uploadImage")),s=domain.action("uploadVoice"),c=domain.action("likeNote"),a=domain.action("unlikeNote"),r=domain.action("deleteComment");i.section=this.opts.section,i.isNew=!!this.opts["new"],i.parent=i.isNew?i.parent:i.parent.parent,i.confirmComponent=i.parent.tags["note-confirm"],i.initiator=i.section.initiator||i.parent.user,i.initiator.headimgurl=i.initiator.headimgurl||"/public/images/def-avatar.png",i.isOnEdit=function(){return i.isNew?!i.section.parentNote||i.section.parentNote&&"dr"===i.section.status:i.parent.currNote===i.section},i.trash=[],i.inTrash=function(t){return function e(i){return i[0]._id===t?!0:i.slice(1).length>0?e(i.slice(1)):!1}(i.trash)},i.viewModel={toggleTxtVoiBtn:{txt:!0,voi:!1,toggle:function(){var t=i.viewModel.toggleTxtVoiBtn;t.txt=!t.txt,t.voi=!t.voi}},input:{wait:!0,editTxt:!1,doWait:function(){this.wait=!0,this.editTxt=!1},doEdit:function(){this.wait=!1,this.editTxt=!0}}},i.init=function(){i.isNew&&(i.section={mates:[]}),i.trash=[]},i.formatDate=util.formatDateForComments,i.on("update",function(){i.section=i.opts.section}),i.pushToTrash=function(t){return i.trash.length<=0?void i.trash.push(t.item):void i.trash.forEach(function(e,n){e._id===t.item._id?i.trash.splice(n,1):n===i.trash.length-1&&i.trash.push(t.item)})},i.editSectionNote=function(t){i.init(),i.parent.selectNote(i.section)},i.clearTrash=function(){var t=i.trash.map(function(t){return t._id});e.newInvocation({notes:t}).onDone(function(t){t.success?(i.section.mates=i.section.mates.filter(function(t){for(var e=0,n=i.trash.length;n>e;e++)if(i.trash[e]._id===t._id)return!1;return!0}),i.trash=[],i.update()):alert(t.error)}).execute()},i.deleteComment=function(t){function e(){o(),r.newInvocation({id:t.item._id}).onDone(function(e){e.success?i.section.comments.forEach(function(e,n){e._id==t.item._id&&i.section.comments.splice(n,1),i.update()}):alert("delete comments failed.")}).execute()}function n(){o()}function o(){i.confirmComponent.off("confirm",e),i.confirmComponent.off("cancel",n)}var s=t.item.initiator;return s._id!=i.parent.user._id?!1:(i.confirmComponent.one("confirm",e),i.confirmComponent.one("cancel",n),void i.confirmComponent.trigger("popUp"))},i.cancelSectionNote=function(t){i.init(),i.parent.trigger("cancel",i.section)},i.submitSectionNote=function(t){function c(){if(i.section.mates=i.section.mates.filter(function(t){for(var e=0,n=i.trash.length;n>e;e++)if(i.trash[e]._id===t._id)return!1;return!0}),i.section.mates.length<=0)return i.init(),void i.parent.trigger("noteSubmit",i.section);var t=0;i.section.mates.forEach(function(e){e.status&&"dr"!==e.status?++t===i.section.mates.length&&a():"img"===e.type&&e.url?wx.uploadImage({localId:e.url,isShowProgressTips:0,success:function(n){o.newInvocation({media_id:n.serverId}).onDone(function(n){e.url=n.url,++t===i.section.mates.length&&a()}).execute()}}):"voi"===e.type&&e.url?wx.uploadVoice({localId:e.url,isShowProgressTips:0,success:function(n){s.newInvocation({media_id:n.serverId}).onDone(function(n){e.url=n.url,++t===i.section.mates.length&&a()}).execute()}}):++t===i.section.mates.length&&a()})}function a(){n.newInvocation(i.section).onDone(function(t){try{util.mixin(i.section,t),i.isNew&&i.parent.pageNote.mates.push(i.section),i.init(),i.parent.trigger("noteSubmit",i.section)}catch(e){alert(JSON.stringify(e))}}).execute()}if(i.section._id&&!(i.section&&i.section.mates&&i.section.mates.length<=0))if(i.trash.length>0){var r=i.trash.map(function(t){return t._id});e.newInvocation({notes:r}).onDone(function(t){t.success?c():alert(t.error)}).execute()}else c()},i.comment=function(t){i.parent.trigger("comment",i.section)},i.like=function(t){var e=null;i.section.likes.length>0&&i.section.likes.forEach(function(t){t.initiator._id===i.parent.user._id&&(e=t)}),e?a.newInvocation({interaction:e._id,note:i.section._id}).onDone(function(t){t.success?(i.section.likes=i.section.likes.filter(function(t){return t.initiator._id!=i.parent.user._id}),i.update()):alert("failed to unlike item")}).execute():c.newInvocation({interaction:{initiator:i.parent.user._id},note:i.section._id}).onDone(function(t){t&&t.like?(i.section.likes.push(t.like),i.update()):alert("failed to like item")}).execute()};var l,d=!1,u="";i.playVoice=function(t){var i=t.item;"dr"===i.status?wx.playVoice({localId:i.url}):($("#voiceMsgPlayer").attr("src",i.url),clearTimeout(l),l=setTimeout(function(){d=!1},1e3*parseInt(i.seconds)),d&&u===i.url?d=!1:(document.getElementById("voiceMsgPlayer").play(),d=!0,u=i.url))}});}