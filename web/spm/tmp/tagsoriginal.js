riot.tag("note-comment",'<div class="feature_area"> <div> <div class="txt_area"> <input oninput="{noteEditInput}" name="txtInput" placeholder="点击输入文字" value=""> </div> <div class="toggle_menu"> <div onclick="{addComment}" class="send_btn" if="{viewModel.input.editTxt}">发送</div> </div> </div> <div style="clear: both"></div> </div>',"note-comment .feature_area{ height: 48px; background: white; width: 100%; overflow: hidden; position: fixed; bottom: 0px; z-index: 1000; } note-comment .feature_area >div{ overflow: hidden; margin-top: 8px; } note-comment .feature_area >div >div{ height: 32px; float:left; } note-comment .feature_area .toggle_txt_voi{ width:15%; } note-comment .feature_area .txt_area{ width: 70%; } note-comment .feature_area .voi_area{ width: 70%; } note-comment .feature_area .voi_area input{ width: 100%; height: 32px; box-sizing: border-box; border: 1px solid #ccc; font-size: 16px; border-radius: 5px; text-align: center; color: #ccc; } note-comment .feature_area .txt_area input{ width: 100%; height: 32px; box-sizing: border-box; border: none; border-bottom: 1px solid #ccc; font-size: 16px; } note-comment .feature_area .toggle_menu{ width: 15%; } note-comment .feature_area .send_btn{ margin: 0px auto; width: 60px; height: 32px; line-height: 32px; border: 1px solid #ccc; box-sizing:border-box; border-radius: 5px; background: #18c54b; border: none; text-align: center; color: white; } note-comment .feature_area .toggle_btn{ margin: 0px auto; width: 32px; height: 32px; border-radius: 50em; border: 1px solid #ccc; box-sizing:border-box; }",function(t){var e=this,i=domain.action("saveComment");e.viewModel={input:{wait:!0,editTxt:!1,doWait:function(){this.wait=!0,this.editTxt=!1},doEdit:function(){this.wait=!1,this.editTxt=!0}}},e.quitComment=function(t){e.parent.trigger("quitComment")},e.addComment=function(t){""!==e.txtInput.value.trim()&&i.newInvocation({note:e.parent.currComment._id,interaction:{initiator:e.parent.user._id,content:e.txtInput.value.trim()}}).onDone(function(t){e.txtInput.value="",e.viewModel.input.doWait(),e.parent.trigger("noteComment",t.comment)}).execute()},e.noteEditInput=function(t){var i=t.currentTarget.value.trim();i?e.viewModel.input.doEdit():e.viewModel.input.doWait()}});
riot.tag("note-confirm",'<div class="weui_dialog_confirm" id="dialog1" if="{show}"> <div class="weui_mask"></div> <div class="weui_dialog"> <div class="weui_dialog_hd"><strong class="weui_dialog_title">{text}</strong></div> <div class="weui_dialog_ft"> <a onclick="{cancel}" class="weui_btn_dialog default">取消</a> <a onclick="{confirm}" class="weui_btn_dialog primary">确定</a> </div> </div> </div>',function(i){var a=this;a.show=!1,a.currTag=null,a.on("popUp",function(i){i&&i.text?a.text=i.text:a.text="是否删除评论",a.show=!0,a.update()}),a.confirm=function(i){a.trigger("confirm"),a.show=!1},a.cancel=function(i){a.trigger("cancel"),a.show=!1}});
riot.tag("note-edit",'<button onclick="{showInput}">显示输入</button> <note-input></note-input> <div class="page" if="{!hidden}"> <div class="title"> <input class="input" onblur="{updatePageNote}" type="text" value="{pageNote.title}" placeholder="添加标题" name="titleInput"> <div if="{false}" class="reference"> <img class="user-icon" riot-src="{user.headimgurl}"> <label class="user-icon"> {user.nickname}</label> <span> 创建于{formatDate(new Date())}</span> </div> <div class="line"></div> </div> <div> <note-section name="{item._id}" each="{item, i in pageNote.mates}" if="{parent.sectionShowOrNot(item)}" section="{item}"></note-section> <note-section if="{pageNoteMode.status.edit && (currNote === newSection)}" section="{newSection}" new="true"></note-section> </div> <div if="{pageNoteMode.status.view}" class="add-section-bar"><div class="add-section"> <div onclick="{selectOperate}"><img src="/public/images/add.png"></div> </div></div> <ul if="{false}" class="btn-group" > <li><a class="weui_btn weui_btn_mini weui_btn_primary">文字</a></li> <li><a class="weui_btn weui_btn_mini weui_btn_primary">图片</a></li> <li><a class="weui_btn weui_btn_mini weui_btn_primary">语音</a></li> <li><a class="weui_btn weui_btn_mini weui_btn_primary">小视频</a></li> </ul> <div> <span if="{pageNote.parentNote}">{pageNote.txt}</span> </div> <div style="clear: both"></div> <div class="mask" if="{pageNoteMode.status.comment}" ontouchstart="{quitCommentWithClickMask(currComment)}" riot-style="height: {window.innerHeight + \'px\'}"></div> </div> <note-confirm></note-confirm> <note-footer if="{Object.keys(currNote).length}"></note-footer> <note-comment if="{currComment}"></note-comment>  <div style="position:absolute;top:0;left:0;width:0;height:0;"> <audio id="voiceMsgPlayer" class="voicePlayer"></audio> </div> ',"note-edit .mask{ width: 100%; position: fixed; top: 0px; left: 0px; z-index: 2; } note-edit :focus{ outline: none; } note-edit .title-input1{ font-size: 16px; display: inline-block; height:30px; line-height: 30px; background: transparent; border: none; } note-edit .note_items div{ height: 40px; line-height: 40px; } note-edit body{ font-size: 14px; } note-edit .btn-group{ list-style-type: none; } note-edit .btn-group li{ float:left; padding:10px; }",function(e){"use strict";var t=this,o=this.opts.id,i=window.location.href,n=domain.action("loadNote"),a=domain.action("updateNote"),u=domain.action("shareAction"),s=function(e){e.error?alert(e.error.message):util.mixin(t.pageNote,e)},c=function(e){if(e&&(t.pageNote=e,t.pageNote.mates&&t.pageNote.mates.length)){var o=t.pageNote.mates.filter(function(e){return"dr"===e.status?e:void 0});o&&o.length&&(t.pageNote.mates=util.arr.rest(t.pageNote.mates,o),t.newSection=o[0],t.selectNote(t.newSection))}t.hidden=!1;var i=document.body.querySelector("body >div");i.removeChild(i.querySelector("#welcomeWrapper")),t.update()};t.hidden=!0,t.pageNote=null,t.newSection={},t.newSection.mates=[],t.currNote={},t.currComment=null,t.user=__page.user,t.user.headimgurl=t.user.headimgurl||"/public/images/def-avatar.png",t.formatDate=function(e){return new Date(e).toLocaleString()},t.formatDateForMates=util.formatDateForComments,t.pageNoteMode={status:{view:!0,edit:!1,comment:!1},doView:function(e){t.pageNoteMode.status.view=!0,t.pageNoteMode.status.edit=!1,t.pageNoteMode.status.comment=!1,t.currNote=null,t.currComment=null,t.newSection={},t.newSection.mates=[],e._id&&console.log(e._id)},doEdit:function(){t.pageNoteMode.status.edit=!0,t.pageNoteMode.status.view=!1,t.pageNoteMode.status.comment=!1,t.currComment=null,t.trigger("edit")},doComment:function(){t.pageNoteMode.status.view=!1,t.pageNoteMode.status.edit=!1,t.pageNoteMode.status.comment=!0,t.currNote=null}},t.init=function(){t.pageNote={title:null,comments:null,crtOn:null,_id:null},t.titleInput.value="",wx.onMenuShareTimeline({title:t.pageNote.title||__app.resources.app.title,link:i,imgUrl:__page.baseUrl+"/public/images/logo_share_48x48.jpg",success:function(){u.execute({id:t.pageNote._id})},cancel:function(){}}),wx.onMenuShareAppMessage({title:t.pageNote.title||__app.resources.app.title,desc:"",link:i,imgUrl:__page.baseUrl+"/public/images/logo_share_48x48.jpg",success:function(){u.execute({id:t.pageNote._id})},cancel:function(){}})},t.sectionShowOrNot=function(e){if(t.pageNoteMode.status.view&&"dr"!=e.status)return!0;if(t.pageNoteMode.status.edit&&"dr"!=e.status){if(t.currNote._id===e._id)return!0}else if(t.pageNoteMode.status.comment&&"dr"!=e.status&&t.currComment._id===e._id)return!0;return!1},t.quitCommentWithClickMask=function(e){return function(o){t.pageNoteMode.doView(e)}},t.on("cancel",function(e){t.pageNoteMode.doView(e),t.currNote=null,t.update()}),t.on("quitComment",function(){t.pageNoteMode.doView(t.currComment),t.currComment=null,t.update()}),t.on("comment",function(e){t.pageNoteMode.doComment(),t.currComment=e,t.update()}),t.on("noteComment",function(e){t.currComment.comments.push(e),t.pageNoteMode.doView(t.currComment),t.update()}),t.updatePageNote=function(e){var o=e.currentTarget.value;o&&a.execute({id:t.pageNote._id,title:o})},t.selectNote=function(e,o){t.currNote=e,t.currComment=null,t.update()},t.selectOperate=function(e){t.pageNoteMode.doEdit(),t.selectNote(t.newSection)},t.on("editSectionNote",function(e){t.pageNoteMode.doEdit(),t.selectNote(e)}),t.on("noteSubmit",function(e){t.pageNoteMode.doView(e),t.update()}),t.on("noteSave",function(){t.update()}),t.on("active",function(e){t.selectNote(e.section,e)}),t.on("mount",function(){console.info("tag pageNote new is opening"),n.onDone(c),a.onDone(s),t.init(),t.pageNote._id=o,n.execute({noteId:t.pageNote._id})}),t.on("unmount",function(){n.offDone(c),a.offDone(s)});var r,l=!1,d=!1,p="";wx.ready(function(){wx.onVoicePlayEnd({success:function(e){console.error("voice play end"),d=!1}})}),t.on("playVoice",function(e,t,o){console.info("start play voice"),"dr"===t?d&&p===e?(wx.stopVoice({localId:e}),d=!1):(wx.playVoice({localId:e}),p=e,d=!0):($("#voiceMsgPlayer").attr("src",e),p.indexOf("weixin")>=0&&(wx.stopVoice({localId:p}),d=!1),clearTimeout(r),r=setTimeout(function(){l=!1},1e3*o),l&&p===e?l=!1:(document.getElementById("voiceMsgPlayer").play(),l=!0,p=e))}),this.goToAuthorize=function(e){var t="/auth/authorize?";t+="route=get_user_info&returnUrl="+location.href,location.href=t}.bind(this),this.showInput=function(e){var o=t.tags["note-input"];o.show(!0)}.bind(this),console.log("execute to the end")});
riot.tag("note-footer",'<div id="mask"> <div id="stop-record-tip"> <span>松开手结束录音</span> </div> </div> <div class="footerWrapper"> <div class="feature_area"> <div> <div class="toggle_txt_voi"> <div onclick="{viewModel.toggleTxtVoiBtn.toggle}" class="toggle_btn"></div> </div> <div if="{viewModel.toggleTxtVoiBtn.txt}" class="txt_area"> <input oninput="{noteEditInput}" name="txtInput" placeholder="点击输入文字" value=""> </div> <div if="{viewModel.toggleTxtVoiBtn.voi}" class="voi_area" ontouchstart="{voiceAreaTouchStart}" ontouchend="{voiceAreaTouchEnd}"> <input type="button" value="长按录音"> </div> <div class="toggle_menu"> <div onclick="{toggleSubMenu}" class="toggle_btn menu_btn" if="{viewModel.input.wait}">菜单</div> <div onclick="{addTxt}" class="send_btn" if="{viewModel.input.editTxt}">发送</div> </div> </div> <div style="clear: both"></div> </div> <div if="{viewModel.subMenu.showState}" class="scale_area"> <ul> <li class="img_btn" onclick="{addImgs}">图片</li> <li class="video_btn">视频</li> </ul> </div> </div>',"note-footer .footerWrapper{ position: fixed; width: 100%; z-index: 10000; overflow: hidden; bottom: 0px; } note-footer .record_progress_bar { margin-top: 10px; background-color: #EBEBEB; height: 3px; -webkit-box-flex: 1; -webkit-flex: 1; -ms-flex: 1; flex: 1; } note-footer .record_progress_inner_bar { width: 0; height: 100%; background-color: #09BB07; } note-footer .record_detail_area{ -webkit-user-select: none; display: none; position: absolute; float: left; bottom: 0px; width: 100%; height: 140px; background-color: rgba(51, 51, 51, 0.5); z-index: 999; } note-footer .scale_area{ height: 96px; border-top: 1px solid #ccc; background: white; } note-footer .scale_area ul{ width: 80%; list-style-type: none; margin: 0px auto; padding: 0px; margin-top: 28px; overflow: hidden; } note-footer .scale_area ul li{ float: left; margin-left: 10%; width: 40px; height: 40px; border: 1px solid #ccc; } note-footer .scale_area ul li:first-child{ float: left; margin-left: 0px; } note-footer .scale_area .img_btn{ } note-footer .feature_area{ height: 48px; background: white; width: 100%; overflow: hidden; } note-footer .feature_area >div{ overflow: hidden; margin-top: 8px; } note-footer .feature_area >div >div{ height: 32px; float:left; } note-footer .feature_area .toggle_txt_voi{ width:15%; } note-footer .feature_area .txt_area{ width: 70%; } note-footer .feature_area .voi_area{ width: 70%; } note-footer .feature_area .voi_area input{ width: 100%; height: 32px; box-sizing: border-box; border: 1px solid #ccc; font-size: 16px; border-radius: 5px; text-align: center; color: #ccc; } note-footer .feature_area .txt_area input{ width: 100%; height: 32px; box-sizing: border-box; border: none; border-bottom: 1px solid #ccc; font-size: 16px; } note-footer .feature_area .toggle_menu{ width: 15%; } note-footer .feature_area .send_btn{ margin: 0px auto; width: 60px; height: 32px; line-height: 32px; border: 1px solid #ccc; box-sizing:border-box; border-radius: 5px; background: #18c54b; border: none; text-align: center; color: white; } note-footer .feature_area .toggle_btn{ margin: 0px auto; width: 32px; height: 32px; border-radius: 50em; border: 1px solid #ccc; box-sizing:border-box; } note-footer .feature_area .scale_area{ height: 48px; } note-footer .voi_area-el{ margin-top: 5px; float: left; margin-left: 40px; } note-footer .record-el-container{ width: 80%; margin: 0 auto; } note-footer #stop-record{ background: url(/web/images/stop-active.png); width: 72px; height: 72px; background-color: white; border-radius: 40px; } note-footer #play-record{ display: none; background: url(/web/images/start-active.png); width: 72px; height: 72px; background-color: white; border-radius: 40px; } note-footer #pause-record{ display: none; background: url(/web/images/start-active.png); width: 72px; height: 72px; background-color: white; border-radius: 40px; } note-footer #confirm-sub-voice{ display: none; } note-footer #confirm-sub-voice::before{ font-size: 45px; } note-footer #mask{ position: fixed; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);; left: 0; top: 0; z-index: 1000; display: none; } note-footer #stop-record-tip{ margin: 0 auto; width: 120px; margin-top: 250px; color: white; }",function(e){var o=this,t=domain.action("saveNotesInSection"),r=domain.action("saveNoteInSection");o.viewModel={toggleTxtVoiBtn:{txt:!0,voi:!1,toggle:function(){var e=o.viewModel.toggleTxtVoiBtn;e.txt=!e.txt,e.voi=!e.voi}},subMenu:{showState:!1,toggle:function(){var e=o.viewModel.subMenu;e.showState=!e.showState},show:function(){var e=o.viewModel.subMenu;e.showState=!0},hide:function(){var e=o.viewModel.subMenu;e.showState=!1}},input:{wait:!0,editTxt:!1,doWait:function(){this.wait=!0,this.editTxt=!1},doEdit:function(){this.wait=!1,this.editTxt=!0}}},o.addTxt=function(e){""!==o.txtInput.value.trim()&&r.newInvocation({type:"txt",content:o.txtInput.value.trim(),parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id}).onDone(function(e){util.mixin(o.parent.currNote,e.sectionNote),o.parent.currNote.mates.push(e.note),o.txtInput.value="",o.viewModel.input.doWait(),o.parent.trigger("noteSave",e.note)}).execute()},o.addImgs=function(e){wx.chooseImage({count:9,sizeType:["compressed"],sourceType:["album","camera"],success:function(e){var r=e.localIds.map(function(e){return{type:"img",url:e,parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id}});t.newInvocation({notes:r}).onDone(function(e){e?(o.parent.currNote.mates||(o.parent.currNote.mates=[]),e.parentNote&&util.mixin(o.parent.currNote,e.parentNote),o.parent.currNote.mates=o.parent.currNote.mates.concat(e.mates),o.parent.trigger("noteSave",e)):alert("error occur.")}).execute()}})},o.noteEditInput=function(e){var t=e.currentTarget.value.trim();t?o.viewModel.input.doEdit():o.viewModel.input.doWait()},o.toggleSubMenu=function(e){o.viewModel.subMenu.toggle()},o.on("edit",function(){o.txtInput.focus()});var i,n,a,c={},d=!1;wx.ready(function(){console.log("ready"),wx.onVoiceRecordEnd({complete:function(e){console.error("end"),a=(new Date).getTime(),$("#stop-record").hide(),$("#play-record").show(),$("#confirm-sub-voice").show();var o=e.localId;c.localId=o}}),wx.onVoicePlayEnd({success:function(e){e.localId}})}),o.voiceAreaTouchStart=function(e){console.error("startRecord"),n=(new Date).getTime(),i=setTimeout(function(){$("#mask").show(),wx.startRecord()},300)},o.voiceAreaTouchEnd=function(e){console.error("touchend"),a=(new Date).getTime(),300>a-n?(a=0,n=0,clearTimeout(i)):wx.stopRecord({success:function(e){console.log(e),$("#mask").hide();var t=e.localId,i=((a-n)/1e3).toFixed(0);n=0,a=0;var c={type:"voi",url:t,seconds:i,parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id};r.newInvocation(c).onDone(function(e){e?(util.mixin(o.parent.currNote,e.sectionNote),o.parent.currNote.mates.push(e.note),o.parent.trigger("noteSave",e.note)):alert("error occur.")}).execute()}})},o.stopRecord=function(e){d=!0,a=(new Date).getTime(),wx.stopRecord({success:function(e){console.log(e),$("#stop-record").hide(),$("#play-record").show(),$("#confirm-sub-voice").show();var o=e.localId;c.localId=o}})},o.playRecord=function(e){wx.playVoice({localId:c.localId}),$("#play-record").hide(),$("#pause-record").show()},o.pauseRecord=function(e){wx.pauseVoice({localId:c.localId}),$("#pause-record").hide(),$("#play-record").show()},o.confirmSubVoice=function(e){$(".record_detail_area").hide();var t=((a-n)/1e3).toFixed(0);n=0,a=0,$(".js_progress").css({width:"0%"}),$(".voice-seconds-container").css({"padding-left":"0%"}),$("#voice-seconds").text(0),d=!1,$("#stop-record").show(),$("#play-record").hide(),$("#confirm-sub-voice").hide(),$("#pause-record").hide();var i={type:"voi",url:c.localId,seconds:t,parentNote:o.parent.currNote._id||"",pageNoteId:o.parent.pageNote._id};wx.pauseVoice({localId:c.localId}),r.newInvocation(i).onDone(function(e){e?(util.mixin(o.parent.currNote,e.sectionNote),o.parent.currNote.mates.push(e.note),o.parent.trigger("noteSave",e.note)):alert("error occur.")}).execute()}});
riot.tag("note-input",'<div if="{!hidden}" class="note-input"> <div class="bar"> <table style="width:100%" cellspacing="0" cellpadding="0"> <tr> <td width="52px"> <div class="btn"> <img src="/public/images/input_keyboard.png"> </div> </td> <td width="100%"> <div class="text"> <div class="inline" style="float: left; width: 80%;"> <input type="text"> </div> <div class="inline" style="float: right; width: 30px;"> <div class="emoji"> <img src="/public/images/input_emoji.png"> </div> </div> </div> </td> <td width="52px"> <div class="btn"> <img src="/public/images/input_add.png"> </div> </td> </tr> </table> </div> <div class="more" style="display: none;"> <table style="width:100%" cellspacing="0" cellpadding="0"> <tr> <td> more </td> </tr> <tr> <td> </td> </tr> <tr> <td> <div> <img src=""> </div> </td> </tr> </table> </div> </div>',function(i){var t=this;t.hidden=!1,t.show=function(i){this.update({hidden:!i})}});
riot.tag("note-menu","<div>头部</div>","note-menu div{ height: 30px; line-height: 30px; background: #989898; text-align: center; color: white; }",function(e){});
riot.tag("note-section",'<div class="page" if="{!hidden}"> <div class="section" sectionid="{_id}"> <div class="panel"> <div class="top-padding"></div> <div class="author" > <div style="display: inline; float: left;"> <img class="user-icon" riot-src="{initiator.headimgurl}"> </div> <div style="display: inline; float: left; padding-left: 10px;"> <label class="user-nickname"> {initiator.nickname}</label> </div> <div style="display: inline; float: left; padding-left: 10px;"> <span if="{section.parentNote && section.status != \'dr\'}">{formatDate(new Date(section.crtOn))}</span> </div> </div> <div class="top" > <label class="btn active" onclick="{submitSectionNote}" if="{isOnEdit() && (initiator._id === parent.user._id)}" >确定</label> <label class="btn" onclick="{cancelSectionNote}" if="{isOnEdit() && (initiator._id === parent.user._id)}" >取消</label> </div> <div class="noteItems"> <div each="{section.mates}" noteid="{_id}" style="margin-top: 2px" onclick="{parent.deleteNote}"> <div if="{type===\'txt\'}" class="note_txt">{content}</div> <div if="{type===\'img\'}" class="note_img"><img style="width: 100%" riot-src="{url}"></div> <div if="{type===\'voi\'}" class="note_voi" style="float:left"><div riot-style="width: {seconds * 3 + 30}px" class="voice" onclick="{parent.playVoice}"><i class="playIcon"></i></div><span class="seconds">{seconds}"</span></div> <div style="clear: both;"></div> </div> </div> <div class="bottom"> <table style="width:100%;" cellpadding="0" cellspacing="0"> <tr> <td style="width:50%;"> <div class="img-btn left" onclick="{editSectionNote}" if="{!isOnEdit() && (initiator._id === parent.user._id)}"> <img src="/public/images/edit.png"> </div> </td> <td style="width:50%;"> <div class="right"> <div id="interactBlock" if="{!isNew}" class="left" style="display: inline-block; height: 24px;"> <div onclick="{like}" class="img-btn left"> <img riot-src="{isLiked()? \'/public/images/liked.png\': \'/public/images/like.png\'}"> </div> <div onclick="{comment}" class="img-btn left" style="display: inline-block; "> <img src="/public/images/comment.png"> </div> </div> </div> </td> </tr> </table> </div> </div> <div class="interact" if="{!isNew}"> <div class="likes" > <ul> <li each="{section.likes}"> <div><img class="user-icon" riot-src="{initiator.headimgurl}"></div> </li> </ul> </div> <div class="comments"> <ul> <li each="{section.comments}" onclick="{parent.deleteComment}"> <table style="width:100%;" cellpadding="0" cellspacing="0"> <tr> <td style="width: 24px;"> <div> <img class="user-icon" riot-src="{initiator.headimgurl}"> </div> </td> <td> <div> <span>{content}</span> </div> </td> <td style="width: 20px; "> <div> <img class="small-icon" src="/public/images/trashbin.png"> </div> </td> <td style="width: 60px;"> <div> <span style="font-size: 12px; float:right">{parent.formatDate(new Date(crtOn))}</span> </div> </td> </tr> </table> </li> </ul> </div> </div> <div class="bottom-padding"></div> </div> </div>',"note-section label{ font-size: 14px; } note-section .interact_box{ line-height: 40px; border-top: 1px solid #ddd; } note-section .interact_box .comments img{ width: 32px; height: 32px; border: none; border-radius: 50em; vertical-align: middle; } note-section .noteItems div{ line-height: 31px; } note-section .noteItems div .note_img{ width:100%; } note-section .note_section{ width: 94%; border: 1px solid #ddd; margin: 15px auto; background: white; padding: 10px; padding-bottom: 0px; font-size: 14px; } note-section .note_section .featureArea{ margin-top: 10px; position: relative; } note-section .note_section .featureArea .send_btn{ display: block; float: right; height: 32px; } note-section .note_section textarea{ height: 32px; line-height: 32px; position: absolute; bottom: 2px; margin: 0px auto; left: 50px; display: block; width: -webkit-calc(100% - 100px); width: -moz-calc(100% - 100px); width: calc(100% - 100px); border: none; border-bottom: 1px solid #18c54b; font-size: 14px; } note-section .voice{ margin-left: 10px; float: left; background-color: #04BE02; border-radius: 7px; } note-section .seconds{ float: left; font-size: 12px; margin-left: 5px; } note-section .playIcon{ background: url('/web/images/wx-icon.png') 0 -2428px; background-size: 150px 2489px; width: 23px; height: 23px; vertical-align: middle; display: inline-block; }",function(i){var t=this,e=(domain.action("saveNoteInSection"),domain.action("updateNote"),domain.action("deleteNotes")),n=domain.action("publishNote"),o=(domain.action("saveNotesInSection"),domain.action("uploadImage")),s=domain.action("uploadVoice"),c=domain.action("likeNote"),a=domain.action("unlikeNote"),d=domain.action("deleteComment");t.section=this.opts.section,t.isNew=!!this.opts["new"],t.parent=t.isNew?t.parent:t.parent.parent,t.confirmComponent=t.parent.tags["note-confirm"],t.initiator=t.section.initiator||t.parent.user,t.initiator.headimgurl=t.initiator.headimgurl||"/public/images/def-avatar.png",t.isOnEdit=function(){return t.isNew?!t.section.parentNote||t.section.parentNote&&"dr"===t.section.status:t.parent.currNote===t.section},t.viewModel={toggleTxtVoiBtn:{txt:!0,voi:!1,toggle:function(){var i=t.viewModel.toggleTxtVoiBtn;i.txt=!i.txt,i.voi=!i.voi}},input:{wait:!0,editTxt:!1,doWait:function(){this.wait=!0,this.editTxt=!1},doEdit:function(){this.wait=!1,this.editTxt=!0}}},t.init=function(){t.isNew&&(t.section={mates:[]})},t.formatDate=util.formatDateForComments,t.on("update",function(){t.section=t.opts.section}),t.editSectionNote=function(i){t.init(),t.parent.trigger("editSectionNote",t.section)},t.deleteNote=function(i){return t.isOnEdit()&&t.initiator._id===t.parent.user._id?void t.confirm({text:"是否删除该行"},function(){e.newInvocation({notes:[i.item._id]}).onDone(function(e){e.success?(t.section.mates.forEach(function(e,n){e._id===i.item._id&&t.section.mates.splice(n,1)}),t.update()):alert(e.error)}).execute()}):!1},t.confirm=function(i,e){function n(){s(),e()}function o(){s()}function s(){t.confirmComponent.off("confirm",n),t.confirmComponent.off("cancel",o)}t.confirmComponent.one("confirm",n),t.confirmComponent.one("cancel",o),t.confirmComponent.trigger("popUp",i)},t.deleteComment=function(i){var e=i.item.initiator;return e._id!=t.parent.user._id?!1:void t.confirm({text:"是否删除评论"},function(){d.newInvocation({id:i.item._id}).onDone(function(e){e.success?t.section.comments.forEach(function(e,n){e._id==i.item._id&&t.section.comments.splice(n,1),t.update()}):alert("delete comments failed.")}).execute()})},t.cancelSectionNote=function(i){t.init(),t.parent.trigger("cancel",t.section)},t.submitSectionNote=function(i){function e(){n.newInvocation(t.section).onDone(function(i){try{util.mixin(t.section,i),t.isNew&&t.parent.pageNote.mates.push(t.section),t.parent.trigger("noteSubmit",t.section),t.init()}catch(e){alert(JSON.stringify(e))}}).execute()}if(t.section._id&&!(t.section&&t.section.mates&&t.section.mates.length<=0)){if(t.section.mates.length<=0)return t.init(),void t.parent.trigger("noteSubmit",t.section);var c=0;t.section.mates.forEach(function(i){i.status&&"dr"!==i.status?++c===t.section.mates.length&&e():"img"===i.type&&i.url?wx.uploadImage({localId:i.url,isShowProgressTips:0,success:function(n){o.newInvocation({media_id:n.serverId}).onDone(function(n){i.url=n.url,++c===t.section.mates.length&&e()}).execute()}}):"voi"===i.type&&i.url?wx.uploadVoice({localId:i.url,isShowProgressTips:0,success:function(n){s.newInvocation({media_id:n.serverId}).onDone(function(n){i.url=n.url,++c===t.section.mates.length&&e()}).execute()}}):++c===t.section.mates.length&&e()})}},t.comment=function(i){t.parent.trigger("comment",t.section)},t.isLiked=function(){var i=!1;return!t.section.likes||t.section.likes.length<=0?i:(t.section.likes.forEach(function(e){e.initiator._id===t.parent.user._id&&(i=e)}),i)},t.like=function(i){var e=t.isLiked();e?a.newInvocation({interaction:e._id,note:t.section._id}).onDone(function(i){i.success?(t.section.likes=t.section.likes.filter(function(i){return i.initiator._id!=t.parent.user._id}),t.update()):alert("failed to unlike item")}).execute():c.newInvocation({interaction:{initiator:t.parent.user._id},note:t.section._id}).onDone(function(i){i&&i.like?(t.section.likes.push(i.like),t.update()):alert("failed to like item")}).execute()},t.playVoice=function(i){var e=i.item;t.parent.trigger("playVoice",e.url,e.status)}});