<note-page>
    <div class="page" if="{!hidden}">
        <div class="title">
            <input class="input" onblur="{updatePageNote}" type="text" value="{pageNote.title}" placeholder="添加标题" name="titleInput"/>
            <div if="{false}" class="reference">
                <img class="user-icon" riot-src="{user.headimgurl}"/>
                <label class="user-icon"> {user.nickname}</label>
                <span> 创建于{formatDate(new Date())}</span>
            </div>
            <div class="line"/>
        </div>

        <div>
            <note-section id="{item._id}" each="{item, i in pageNote.mates}" if="{parent.sectionShowOrNot(item)}" section="{item}"></note-section>
            <note-section if="{pageNoteMode.status.edit && (currNote === newSection)}" section="{newSection}" new="true"></note-section>
        </div>
        <div if="{pageNoteMode.status.view}" class="add-section-bar"><div class="add-section">
            <div onclick="{selectOperate}"><img src="/public/images/add.png"></div>
        </div></div>

        <ul if="{false}" class="btn-group" >
            <li><a class="weui_btn weui_btn_mini weui_btn_primary">文字</a></li>
            <li><a class="weui_btn weui_btn_mini weui_btn_primary">图片</a></li>
            <li><a class="weui_btn weui_btn_mini weui_btn_primary">语音</a></li>
            <li><a class="weui_btn weui_btn_mini weui_btn_primary">小视频</a></li>
        </ul>
        <div>
            <span if="{pageNote.parentNote}">{pageNote.txt}</span>
        </div>
        <div style="clear: both"></div>
        <div class="mask" if="{pageNoteMode.status.comment}" ontouchstart="{quitCommentWithClickMask(currComment)}" style="height: {window.innerHeight + 'px'}"></div>
    </div>
    <note-confirm></note-confirm>
    <note-input if="{Object.keys(currNote).length}"></note-input>
    <note-comment if="{currComment}"></note-comment>
    <!--play voice panel begin-->
    <div style="position:absolute;top:0;left:0;width:0;height:0;">
        <audio id="voiceMsgPlayer" class="voicePlayer"></audio>
    </div>
    <!--play voice panel end-->
    <style scoped>
        .mask{
            width: 100%;
            position: fixed;
            top: 0px;
            left: 0px;
            z-index: 2;
        }
        :focus{
            outline: none;
        }
        .title-input1{
            font-size: 16px;
            display: inline-block;
            height:30px;
            line-height: 30px;
            background: transparent;
            border: none;
        }
        .note_items div{
            height: 40px;
            line-height: 40px;
        }
        body{
            font-size: 14px;
        }
        .btn-group{
            list-style-type: none;
        }
        .btn-group li{
            float:left;
            padding:10px;
        }
    </style>
    <script>
        "use strict";
        //private properties
        var self = this;
        var id = this.opts.id;
        var url = window.location.href;
        var loadNote = domain.action('loadNote');
        var updateNote = domain.action('updateNote');
        var shareAction = domain.action('shareAction');

        var onUpdateNote = function(data){
            if(!data.error){
                util.mixin(self.pageNote, data);
            }else{
                alert(data.error.message);
            }
        };
        var onLoadNote = function(data){
            if(data){
                self.pageNote = data;
                if(self.pageNote.mates && self.pageNote.mates.length){
                    var draftSections = self.pageNote.mates.filter(function(sectionNote){
                        if(sectionNote.status === 'dr'){
                            return sectionNote;
                        }
                    });
                    if(draftSections && draftSections.length){
                        self.pageNote.mates = util.arr.rest(self.pageNote.mates, draftSections);
                        self.newSection = draftSections[0];
                        self.selectNote(self.newSection);
                    }
                }
            }
            self.hidden = false;
//            var topDiv = document.body.querySelector('body >div');
//            topDiv.removeChild(topDiv.querySelector('#welcomeWrapper'));
            self.update();
        };
        //instance properties
        self.hidden = true;
        self.pageNote = null;
        self.newSection = {};
        self.newSection.mates = [];
        self.currNote = {};
        self.currComment = null;
        self.user = __page.user;
        self.user.headimgurl = self.user.headimgurl || '/public/images/def-avatar.png';
        //instance methods
        self.formatDate = function(date){
            return new Date(date).toLocaleString();
        };
        self.formatDateForMates = util.formatDateForComments;
        self.pageNoteMode = {
            status: {
                view: true,
                edit : false,
                comment: false
            },
            position: {
                start: 0,
                end: 0
            },
            doView: function(section){
                self.pageNoteMode.status.view = true;
                self.pageNoteMode.status.edit = false;
                self.pageNoteMode.status.comment = false;
                self.currNote = null;
                self.currComment = null;
                self.newSection = {};
                self.newSection.mates = [];
                if(section._id){
                    setTimeout(function(){
                        window.scrollTo(0, self.pageNoteMode.position.start);
                    }, 1);
//                    self.root.querySelector('#'+section._id + '>a').scrollIntoView();
                }
            },
            doEdit: function(section){
                self.pageNoteMode.position.start = window.scrollY;
                self.pageNoteMode.status.edit = true;
                self.pageNoteMode.status.view = false;
                self.pageNoteMode.status.comment = false;
                self.currComment = null;
                self.selectNote(section);
                self.trigger('editMode');
            },
            doComment: function(section){
                self.pageNoteMode.position.start = window.scrollY;
                self.pageNoteMode.status.view = false;
                self.pageNoteMode.status.edit = false;
                self.pageNoteMode.status.comment = true;
                self.currComment = section;
                self.currNote = null;
                self.update();
                self.trigger('commentMode');
            }
        };
        self.init = function(){
            self.pageNote = {
                title: null,
                comments: null,
                crtOn: null,
                _id: null
            };
            self.titleInput.value = '';
            wx.onMenuShareTimeline({
                title: self.pageNote.title || __app.resources.app.title,
                link: url,
                imgUrl: __page.baseUrl + '/public/images/logo_share_48x48.jpg',
                success: function(){
                    shareAction.execute({id: self.pageNote._id});
                },
                cancel: function(){}
            });
            wx.onMenuShareAppMessage({
                title: self.pageNote.title || __app.resources.app.title,
                desc: '',
                link: url,
                imgUrl: __page.baseUrl + '/public/images/logo_share_48x48.jpg',
                success: function () {
                    shareAction.execute({id: self.pageNote._id});
                },
                cancel: function () {}
            });
        };
        self.sectionShowOrNot = function(item){
            if(self.pageNoteMode.status.view && item.status != 'dr'){
                return true;
            }
            else if(self.pageNoteMode.status.edit && item.status != 'dr'){
                if(self.currNote._id === item._id){
                    return true;
                }
            }
            else if((self.pageNoteMode.status.comment && item.status != 'dr')) {
                if(self.currComment._id === item._id){
                    return true;
                }
            }
            return false;
        };
        self.quitCommentWithClickMask = function(section){
            return function(e){
                e.preventDefault();
                self.pageNoteMode.doView(section);
                self.update();
            }
        };
        self.on('cancel', function(section){
            self.pageNoteMode.doView(section);
            self.currNote = null;
            self.update();
        });
        self.on('quitComment', function(){
            self.pageNoteMode.doView(self.currComment);
            self.currComment = null;
            self.update();
        });
        self.on('comment', function(section){
            self.pageNoteMode.doComment(section);
        });
        self.on('noteComment', function(comment){
            self.currComment.comments.push(comment);
            self.pageNoteMode.doView(self.currComment);
            self.update();
        });
        self.updatePageNote = function(e){
            var title = e.currentTarget.value;
            if(self.pageNote.initiator != self.user._id || !title){
                return;
            }
            updateNote.execute({
                id: self.pageNote._id,
                title: title
            });
        };
        self.selectNote = function(note, tag){
            self.currNote = note;
            self.currComment = null;
            self.update();
        };
        self.selectOperate = function(e){
            self.pageNoteMode.doEdit(self.newSection);
        };
        self.on('editSectionNote', function(section){
            self.pageNoteMode.doEdit(section);
        });
        self.on('noteSubmit', function(section){
            self.pageNoteMode.doView(section);
            self.update();
        });
        self.on('noteSave', function(){
            self.update();
        });
        self.on('active', function(tag){
            self.selectNote(tag.section, tag)
        });
        self.on('mount', function(){
            console.info('tag pageNote new is opening');
            loadNote.onDone(onLoadNote);
            updateNote.onDone(onUpdateNote);
            self.init();
            self.pageNote._id = id;
            loadNote.execute({
                noteId: self.pageNote._id
            });
        });
        self.on('unmount', function(){
            loadNote.offDone(onLoadNote);
            updateNote.offDone(onUpdateNote);
        });

        var remote_playing = false, local_playing = false, voiceUrl = '', playVoiceEnd;
        wx.ready(function(){
            wx.onVoicePlayEnd({
                success: function (res) {
                    console.error('voice play end');
                    local_playing = false;
                }
            });
        });
        self.on('playVoice', function(url, status, seconds){
            console.info('start play voice');
            if (status === 'dr') {
                if(!local_playing || voiceUrl !== url){
                    wx.playVoice({
                        localId: url
                    });
                    voiceUrl = url;
                    local_playing = true;
                }else{
                    wx.stopVoice({
                        localId: url
                    });
                    local_playing = false;
                }
            }else{
                $('#voiceMsgPlayer').attr('src', url);
                if(voiceUrl.indexOf('weixin') >= 0){
                    wx.stopVoice({
                        localId: voiceUrl
                    });
                    local_playing = false;
                }
                clearTimeout(playVoiceEnd);
                playVoiceEnd = setTimeout(function(){
                    remote_playing = false;
                }, seconds*1000);
                if(!remote_playing || voiceUrl !== url){
                    document.getElementById('voiceMsgPlayer').play();
                    remote_playing = true;
                    voiceUrl = url;
                }else{
                    remote_playing = false;
                }
            }
        });
        goToAuthorize(e){
            var getUserInfoUrl = '/auth/authorize?';
            getUserInfoUrl += 'route=get_user_info&returnUrl='+location.href;
            location.href = getUserInfoUrl;
        }
    </script>
</note-page>