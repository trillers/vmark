<note-page>
    <div class="page" if="{!hidden}">
        <div class="title">
            <input class="input" if="{pageNote.initiator != user._id}" readonly type="text" value="{pageNote.title}" name="titleInput"/>
            <input class="input" if="{pageNote.initiator === user._id}" onblur="{updatePageNote}" type="text" value="{pageNote.title}" placeholder="添加标题" name="titleInput"/>
            <div if="{false}" class="reference">
                <img class="user-icon" riot-src="{user.headimgurl}"/>
                <label class="user-icon"> {user.nickname}</label>
                <span> 创建于{formatDate(new Date())}</span>
            </div>
            <div class="line"/>
        </div>

        <div>
            <page-section name="{item._id}" id="{item._id}" each="{item, i in pageNote.mates}" if="{parent.sectionShowOrNot(item)}" section="{item}"></page-section>
            <page-section name="11" if="{pageNoteMode.status.edit && (currNote === newSection)}" section="{newSection}" new="true"></page-section>
        </div>
        <div if="{pageNoteMode.status.view}" class="add-section-bar">
            <div class="add-section">
                <div onclick="{selectOperate}"><img src="/public/images/add.png"></div>
            </div>
        </div>
        <div if="{pageNoteMode.status.view}" style="width: 100%;text-align: center;margin-bottom: 20px">
            <img style="width: 96px;height: 96px" src="/public/images/qrcode_for_gh_cd89432d0321.jpg"/>
            <p style="margin-top: 20px">长按二维码, 关注有趣笔记</p>
        </div>
        <div>
            <span if="{pageNote.parentNote}">{pageNote.txt}</span>
        </div>
        <div style="clear: both"></div>
        <div class="mask" if="{pageNoteMode.status.comment}" ontouchstart="{quitCommentWithClickMask(currComment)}" style="height: {window.innerHeight + 'px'}"></div>
    </div>
    <note-confirm></note-confirm>
    <note-input-share if="{Object.keys(currNote).length && pageNoteMode.status.edit}"></note-input-share>
    <note-comment if="{currComment}"></note-comment>
    <!--play voice panel begin-->
    <div style="position:absolute;top:0;left:0;width:0;height:0;">
        <audio id="voiceMsgPlayer" class="voicePlayer"></audio>
    </div>
    <!--play voice panel end-->
    <style scoped>
        .mask{
            width: 100%;
            position: fixed;
            top: 0px;
            left: 0px;
            z-index: 5;
        }
        :focus{
            outline: none;
        }
        .title-input1{
            font-size: 16px;
            display: inline-block;
            height:30px;
            line-height: 30px;
            background: transparent;
            border: none;
        }
        .note_items div{
            height: 40px;
            line-height: 40px;
        }
        body{
            font-size: 14px;
        }
        .btn-group{
            list-style-type: none;
        }
        .btn-group li{
            float:left;
            padding:10px;
        }
    </style>
    <script>
        "use strict";
        //private properties
        var self = this;
        var id = this.opts.id;
        var url = window.location.href;
        var loadNote = domain.action('loadNote');
        var updatePageNote = domain.action('updatePageNote');
        var shareAction = domain.action('shareAction');
        var getShareImg = function(){
            if(self.pageNote && self.pageNote.mates && self.pageNote.mates.length){
                for(var i= 0, len=self.pageNote.mates.length; i<len; i++){
                    var section = self.pageNote.mates[i];
                    if(section && section.mates && section.mates.length){
                        for(var j= 0, len2=section.mates.length; j<len2; j++){
                            var note = section.mates[j];
                            if(note.type && note.type === 'img' && note.status != 'dr'){
                                return section.mates[j].url
                            }
                        }
                    }
                }
            }
            return null;
        };
        var onLoadNote = function(res){
            console.log(res)
            if(!res.error){
                self.pageNote = res.note;
                if(self.pageNote.mates && self.pageNote.mates.length){
                    var draftSections = self.pageNote.mates.filter(function(sectionNote){
                        if(sectionNote.status === 'dr'){
                            return sectionNote;
                        }
                    });
                    if(draftSections && draftSections.length){
                        self.pageNote.mates = util.arr.rest(self.pageNote.mates, draftSections);
                        self.newSection = draftSections[0];
                        self.selectNote(self.newSection);
                    }
                }
            }
            self.updateWxShareConfig();
            self.trigger('ready');
        };
        //instance properties
        self.hidden = true;
        self.pageNote = null;
        self.newSection = {};
        self.newSection.mates = [];
        self.currNote = {};
        self.currComment = null;
        self.user = __page.user;
        self.user.headimgurl = self.user.headimgurl || '/public/images/def-avatar.png';
        //instance methods
        self.formatDate = function(date){
            return new Date(date).toLocaleString();
        };
        self.formatDateForMates = util.formatDateForComments;
        self.pageNoteMode = {
            status: {
                view: true,
                edit : false,
                comment: false
            },
            position: {
                start: 0,
                end: 0
            },
            doView: function(section){
                self.pageNoteMode.status.view = true;
                self.pageNoteMode.status.edit = false;
                self.pageNoteMode.status.comment = false;
                self.currNote = null;
                self.currComment = null;
                self.newSection = {};
                self.newSection.mates = [];
                if(section._id){
                    setTimeout(function(){
                        window.scrollTo(0, self.pageNoteMode.position.start);
                    }, 1);
                }
            },
            doEdit: function(section){
                self.pageNoteMode.position.start = window.scrollY;
                self.pageNoteMode.status.edit = true;
                self.pageNoteMode.status.view = false;
                self.pageNoteMode.status.comment = false;
                self.currComment = null;
                self.selectNote(section);
                var scrollHeight = self.root.querySelector('.panel').scrollHeight;
                window.scrollTo(0, scrollHeight);
                self.trigger('editMode');
            },
            doComment: function(section){
                self.pageNoteMode.position.start = window.scrollY;
                self.pageNoteMode.status.view = false;
                self.pageNoteMode.status.edit = false;
                self.pageNoteMode.status.comment = true;
                self.currComment = section;
                self.currNote = null;
                self.update();
                window.scrollTo(0, document.body.scrollHeight);
                self.trigger('commentMode');
            }
        };
        self.updateWxShareConfig = function(){
            setTimeout(function(){
                var shareConfig = {
                    title: self.pageNote && self.pageNote.title || __app.resources.app.title,
                    desc: '',
                    link: url,
                    imgUrl: getShareImg() || __page.baseUrl + '/public/images/logo_share_48x48.jpg',
                    success: function(){
                        shareAction.execute({id: self.pageNote._id});
                    },
                    cancel: function(){}
                };
                wx.onMenuShareTimeline(shareConfig);
                wx.onMenuShareAppMessage(shareConfig);
            }, 500);
        };
        self.sectionShowOrNot = function(item){
            if(self.pageNoteMode.status.view && item.status != 'dr'){
                return true;
            }
            else if(self.pageNoteMode.status.edit && item.status != 'dr'){
                if(self.currNote._id === item._id){
                    return true;
                }
            }
            else if((self.pageNoteMode.status.comment && item.status != 'dr')) {
                if(self.currComment._id === item._id){
                    return true;
                }
            }
            return false;
        };
        self.quitCommentWithClickMask = function(section){
            return function(e){
                e.preventDefault();
                self.pageNoteMode.doView(section);
                self.update();
            }
        };
        self.on('update', function(){
            self.updateWxShareConfig();
        });
        self.on('cancel', function(section){
            self.pageNoteMode.doView(section);
            self.currNote = null;
            self.update();
        });
        self.on('quitComment', function(){
            self.pageNoteMode.doView(self.currComment);
            self.currComment = null;
            self.update();
        });
        self.on('comment', function(section){
            self.pageNoteMode.doComment(section);
        });
        self.on('noteComment', function(comment){
            self.currComment.comments.push(comment);
            self.pageNoteMode.doView(self.currComment);
            self.update();
        });
        self.updatePageNote = function(e){
            var title = e.currentTarget.value;
            if(self.pageNote.initiator != self.user._id || !title){
                return;
            }
            updatePageNote.newInvocation({
                id: self.pageNote._id,
                title: title
            }).onDone(function(data){
                if(!data.error){
                    self.updateWxShareConfig();
                }else{
                    alert(data.error.message);
                }
            }).execute();
        };
        self.selectNote = function(note, tag){
            self.currNote = note;
            self.currComment = null;
            self.update();
        };
        self.isAnonymous = function(){
            return !self.user || !self.user.status || self.user.status === __app.enums.UserStatus.names.Anonymous;
        };
        self.isVerified = function(){
            return self.user && self.user.status && self.user.status === __app.enums.UserStatus.names.Verified;
        };
        self.selectOperate = function(e){
            if(self.isAnonymous()){
                self.goToAuthorize();
            }
            self.pageNoteMode.doEdit(self.newSection);
        };
        self.on('editSectionNote', function(section){
            self.pageNoteMode.doEdit(section);
        });
        self.on('noteSubmit', function(section){
            self.pageNoteMode.doView(section);
            self.update();
            self.updateWxShareConfig();
        });
        self.on('noteSave', function(note){
            self.update();
            var scrollHeight = self.root.querySelector('.panel').scrollHeight;
            window.scrollTo(0, scrollHeight-200);
        });
        self.on('active', function(tag){
            self.selectNote(tag.section, tag)
        });
        self.on('open', function(ctx){
            self.pageNote = {
                comments: null,
                crtOn: null,
                _id: null,
                title: null
            };
            self.titleInput.value = '';
            self.pageNote._id = id;
            loadNote.execute({
                noteId: ctx.id || self.pageNote._id
            });
        });
        self.on('mount', function(){
            loadNote.onDone(onLoadNote);
        });
        self.on('unmount', function(){
            loadNote.offDone(onLoadNote);
        });

        var remote_playing = false, local_playing = false, voiceUrl = '', playVoiceEnd;
        wx.ready(function(){
            wx.onVoicePlayEnd({
                success: function (res) {
                    console.error('voice play end');
                    local_playing = false;
                }
            });
        });
        self.on('playVoice', function(url, status, seconds){
            console.info('start play voice');
            if (status === 'dr') {
                if(!local_playing || voiceUrl !== url){
                    wx.playVoice({
                        localId: url
                    });
                    voiceUrl = url;
                    local_playing = true;
                }else{
                    wx.stopVoice({
                        localId: url
                    });
                    local_playing = false;
                }
            }else{
                $('#voiceMsgPlayer').attr('src', url);
                if(voiceUrl.indexOf('weixin') >= 0){
                    wx.stopVoice({
                        localId: voiceUrl
                    });
                    local_playing = false;
                }
                clearTimeout(playVoiceEnd);
                playVoiceEnd = setTimeout(function(){
                    remote_playing = false;
                }, seconds*1000);
                if(!remote_playing || voiceUrl !== url){
                    document.getElementById('voiceMsgPlayer').play();
                    remote_playing = true;
                    voiceUrl = url;
                }else{
                    remote_playing = false;
                }
            }
        });
        self.goToAuthorize = function(e){
            var getUserInfoUrl = '/auth/authorize?';
            getUserInfoUrl += 'route=get_user_info&returnUrl='+location.href;
            location.href = getUserInfoUrl;
        }
    </script>
</note-page>