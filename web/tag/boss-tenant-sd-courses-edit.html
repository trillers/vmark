<boss-tenant-sd-courses-edit>
    <div if="{!hidden}" class="container" style="margin-top: 0px">
        <div class="row">
            <div class="col-md-3 col-lg-3">
                <boss-tenant-sd-left path="sd/courses"></boss-tenant-sd-left>
            </div>
            <div class="col-md-9 col-lg-9">
                <div class="row" style="text-align: center">
                    <h4>{course.name}</h4>
                </div>
                <alert validators="{validators.raw()}" clear="{clear}"></alert>
                <div class="row">
                    <ul class="nav nav-tabs">
                        <li role="presentation" class="{active: currNav === 0}"><a onclick="{onChangeTab(0)}">课程</a></li>
                        <li role="presentation" class="{active: currNav === 1}"><a onclick="{onChangeTab(1)}">分销</a></li>
                    </ul>
                </div>
                <div class="row" if="{currNav === 0}">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <form class="form-horizontal">
                                <div class="form-group text-left">
                                    <label for="courseNameInput" class="col-sm-2 control-label text-left">课程名称</label>
                                    <div class="col-sm-10 {has-error: !courseNameInput.value.trim()} has-feedback">
                                        <input onblur="{courseNameInputBlur}" value="{course.name}" id="courseNameInput" type="text" class="form-control ">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="coursePromoteInput" class="col-sm-2 control-label">推广语</label>
                                    <div class="col-sm-10">
                                        <input onblur="{coursePromoteInputBlur}" value="{course.slogan}" type="text" class="form-control" id="coursePromoteInput">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="courseMediaPriceInput" class="col-sm-2 control-label">媒体价 ( :元 )</label>
                                    <div class="col-sm-10 {has-error: !courseMediaPriceInput.value.trim()}">
                                        <input onblur="{courseMediaPriceInputBlur}" value="{course.listPrice}" type="number" class="form-control" id="courseMediaPriceInput">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">上/下架状态</label>
                                    <div class="col-sm-10" style="height: 32px;line-height: 32px">
                                        <span>{__app.enums.LiveStatus.values[course.liveStatus]}</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">上/下架时间</label>
                                    <div class="col-sm-10" style="height: 32px;line-height: 32px">
                                        <span>{course.actionTime && _.date.format(new Date(course.actionTime), 'yyyy-MM-dd hh点mm分') || '空'}</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="courseDescInput" class="col-sm-2 control-label">备注</label>
                                    <div class="col-sm-10">
                                        <textarea onblur="{courseDescInputBlur}" type="password" class="form-control" id="courseDescInput">
                                            {course.desc}
                                        </textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="courseDescInput" class="col-sm-2 control-label">轮播焦点图</label>
                                    <div class="col-sm-10">
                                        <input multiple="multiple" onchange="{onBannersChange}" id="bannersInput" type="file" accept="image/jpeg, image/png, image/jpg"/>
                                        <ul class="banners-container">
                                            <li each="{banner, i in course.banners}" onmouseenter="{parent.onHover}" onmouseleave="{parent.onUnHover}">
                                                <div onclick="{parent.removeBanner}" if="{isImgMaskShow}">
                                                    <b>
                                                        <b class="close-a"></b>
                                                        <b class="close-b"></b>
                                                    </b>
                                                </div>
                                                <img riot-src="{banner.data || banner && (__app.settings.api.url + '/file?media_id=' + banner)}"/>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="row" if="{currNav === 1}">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <td class="text-left">
                                <table class="my-table table table-striped">
                                    <tr>
                                        <td><strong>会员折扣</strong></td>
                                        <td>单位课程优惠</td>
                                        <td>
                                            <table>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="memberDiscountsTypeInput1">
                                                                <input onclick="{onSelectMemberDiscountsType1}" id="memberDiscountsTypeInput1" value="{__app.enums.CommissionType.names.Cash}" checked="{course.memberDiscountsType === __app.enums.CommissionType.names.Cash}" type="radio" name="memberDiscountsType">
                                                                金额
                                                            </label>
                                                        </div>

                                                    </td>
                                                    <td>
                                                        <input id="memberDiscountsValueInput1" onblur="{onValidateValue}" disabled="{course.memberDiscountsType != __app.enums.CommissionType.names.Cash}" value="{course.memberDiscountsType === __app.enums.CommissionType.names.Cash && course.memberDiscountsValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="memberDiscountsTypeInput2">
                                                                <input onclick="{onSelectMemberDiscountsType2}" type="radio" name="memberDiscountsType" id="memberDiscountsTypeInput2" value="{__app.enums.CommissionType.names.Percent}" checked="{course.memberDiscountsType === __app.enums.CommissionType.names.Percent}">
                                                                百分比
                                                            </label>
                                                        </div>

                                                    </td>
                                                    <td>
                                                        <input id="memberDiscountsValueInput2" onblur="{onValidatePercent}" disabled="{course.memberDiscountsType != __app.enums.CommissionType.names.Percent}" value="{course.memberDiscountsType === __app.enums.CommissionType.names.Percent && course.memberDiscountsValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td><strong>直接分销商-直接推荐人</strong></td>
                                        <td>单位课程佣金</td>
                                        <td>
                                            <table>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="upLine1CommissionTypeInput1">
                                                                <input onclick="{onSelectUpLine1CommissionType1}" id="upLine1CommissionTypeInput1" value="{__app.enums.CommissionType.names.Cash}" checked="{course.upLine1CommissionType === __app.enums.CommissionType.names.Cash}" type="radio" name="upLine1CommissionType">
                                                                金额
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input id="upLine1CommissionValueInput1" onblur="{onBlurUpLine1CommissionValue('val')}" disabled="{course.upLine1CommissionType != __app.enums.CommissionType.names.Cash}" value="{course.upLine1CommissionType === __app.enums.CommissionType.names.Cash && course.upLine1CommissionValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="upLine1CommissionTypeInput2">
                                                                <input onclick="{onSelectUpLine1CommissionType2}" id="upLine1CommissionTypeInput2" value="{__app.enums.CommissionType.names.Percent}" checked="{course.upLine1CommissionType === __app.enums.CommissionType.names.Percent}" type="radio" name="upLine1CommissionType">
                                                                百分比
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input id="upLine1CommissionValueInput2" onblur="{onBlurUpLine1CommissionValue('percent')}" disabled="{course.upLine1CommissionType != __app.enums.CommissionType.names.Percent}" value="{course.upLine1CommissionType === __app.enums.CommissionType.names.Percent && course.upLine1CommissionValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td><strong>间接分销商-间接推荐人</strong></td>
                                        <td>单位课程佣金</td>
                                        <td>
                                            <table>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="upLine2CommissionTypeInput1">
                                                                <input onclick="{onSelectUpLine2CommissionType1}" id="upLine2CommissionTypeInput1" value="{__app.enums.CommissionType.names.Cash}" checked="{course.upLine2CommissionType === __app.enums.CommissionType.names.Cash}" type="radio" name="upLine2CommissionType">
                                                                金额
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input id="upLine2CommissionValueInput1" onblur="{onBlurUpLine2CommissionValue('val')}" disabled="{course.upLine2CommissionType != __app.enums.CommissionType.names.Cash}" value="{course.upLine2CommissionType === __app.enums.CommissionType.names.Cash && course.upLine2CommissionValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="upLine2CommissionTypeInput2">
                                                                <input onclick="{onSelectUpLine2CommissionType2}" id="upLine2CommissionTypeInput2" value="{__app.enums.CommissionType.names.Percent}" checked="{course.upLine2CommissionType === __app.enums.CommissionType.names.Percent}" type="radio" name="upLine2CommissionType">
                                                                百分比
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input id="upLine2CommissionValueInput2" onblur="{onBlurUpLine2CommissionValue('percent')}" disabled="{course.upLine2CommissionType != __app.enums.CommissionType.names.Percent}" value="{course.upLine2CommissionType === __app.enums.CommissionType.names.Percent && course.upLine2CommissionValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td><strong>第三级分销商-间接推荐人的推荐人</strong></td>
                                        <td>单位课程佣金</td>
                                        <td>
                                            <table>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="upLine3CommissionTypeInput1">
                                                                <input onclick="{onSelectUpLine3CommissionType1}" id="upLine3CommissionTypeInput1" value="{__app.enums.CommissionType.names.Cash}" checked="{course.upLine3CommissionType === __app.enums.CommissionType.names.Cash}" type="radio" name="upLine3CommissionType">
                                                                金额
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input id="upLine3CommissionValueInput1" onblur="{onBlurUpLine3CommissionValue('val')}" disabled="{course.upLine3CommissionType != __app.enums.CommissionType.names.Cash}" value="{course.upLine3CommissionType === __app.enums.CommissionType.names.Cash && course.upLine3CommissionValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="radio form-inline">
                                                            <label for="upLine3CommissionTypeInput2">
                                                                <input onclick="{onSelectUpLine3CommissionType2}" id="upLine3CommissionTypeInput2" value="{__app.enums.CommissionType.names.Percent}" checked="{course.upLine3CommissionType === __app.enums.CommissionType.names.Percent}" type="radio" name="upLine3CommissionType">
                                                                百分比
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input id="upLine3CommissionValueInput2" onblur="{onBlurUpLine3CommissionValue('percent')}" disabled="{course.upLine3CommissionType != __app.enums.CommissionType.names.Percent}" value="{course.upLine3CommissionType === __app.enums.CommissionType.names.Percent && course.upLine3CommissionValue || ''}" class="form-control" type="number"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td colspan="3" style="text-align: center">注： 如果佣金按百分比计算，佣金基数以实际消费者实付金额为准（即线下实际核销金额）</td>
                                    </tr>

                                    <tr>
                                        <td>
                                            <strong>分销海报背景</strong>
                                        </td>
                                        <td colspan="2">
                                            <input onchange="{onFileChange}" id="posterInput" type="file" accept="image/jpeg, image/png, image/jpg"/>
                                            <img style="width: 100px; margin-top: 10px" riot-src="{course.poster && !course.poster.data && __app.settings.api.url + '/file?media_id=' + course.poster || course.poster.data}"/>
                                        </td>
                                    </tr>

                                </table>


                            </div>
                        </div>
                    </div> <!-- panel end -->

                    <div class="row" style="margin-top: 10px">
                        <div class="col-md-12 col-lg-12 text-center">
                            <input disabled="{!courseMediaPriceInput.value.trim() || !courseNameInput.value.trim() || !validators.allOk()}" onclick="{onSubmit}" type="button" class="btn btn-primary" value="保存"/>
                            <a href="#sd/courses" class="btn btn-default">取消</a>
                        </div>
                    </div>

                </div><!-- right end -->

            </div>
        </div>
    </div>
    <style>
        .form-horizontal .control-label{
            text-align: left !important;
        }
        .vcenter {
            vertical-align: middle;
        }
        .my-table{
            width: 100%;
        }
        .my-table td{
            width: 33.33333%;
        }
        .panel-default {
            border-top: none;
            border-color: #ddd;
        }
        .banners-container{
            margin: 0px; margin-top: 10px;overflow: hidden;padding:0px
        }
        .banners-container >li {
            position: relative;width: 100px;height:100px;overflow: hidden;background-color: #EFEFEF; list-style-type:none;float:left;margin-right: 10px;line-height: 100px;text-align: center
        }
        .banners-container >li img{
            width: 100px;
        }
        .banners-container >li div{
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
        }
        .banners-container >li div >b{
            position: absolute;
            top:38px;
            left:38px;
            width:24px;
            height:24px;
        }
        .close-a{
            position: absolute;
            top:0px;
            left:10px;
            width: 4px;
            height: 24px;
            transform:rotate(45deg);
            background: white;
        }
        .close-b{
            position: absolute;
            top:0px;
            left:10px;
            width: 4px;
            height: 24px;
            transform:rotate(135deg);
            background: white;
        }

    </style>
    <script>
        "use strict";
        var self = nest.presentable(this);
        var maxBannerCount = 3;
        var loadCourseByIdAction = domain.action('loadCourseById');
        var updateCourseByIdAction = domain.action('updateCourseById');
        self.currNav = 0;
        self.onChangeTab = function(index){
            return function(){
                self.currNav = index;
            };
        };
        self.on('open', function(ctx){
            var courseId = ctx.req.paramList[0];
            self.posterInput.value = "";
            self.bannersInput.value = "";
            loadCourseByIdAction.newInvocation({
                id: courseId
            }).onDone(function(res){
                self.course = res.course;
                if(!self.course.banners){
                    self.course.banners = [];
                }
                self.trigger('ready', false);
                self.trigger('view-route-to');
            }).execute();
        });
        self.onHover = function(){
            this.isImgMaskShow = true;
        };
        self.onUnHover = function(){
            this.isImgMaskShow = false;
        };
        self.on('mount', function(){
            self.validators = _.widget.validatify([]);
            setTimeout(function(){
                $('#richEditor').summernote({
                    height: 200,
                    minHeight: null,
                    maxHeight: null,
                    focus: true
                });
            }, 100);
        });
        self.courseNameInputBlur = function(){
            var courseName = self.courseNameInput.value.trim();
            if(!courseName){
                return self.validators.addToSet({
                    success: false,
                    field: '课程名称',
                    desc: '不能为空!',
                    key: 'courseNameInput'
                });
            }
            self.course.name = courseName;
        };
        self.clear = function(){
            self.validators.clear();
        };
        self.courseDescInputBlur = function(){
            self.course.desc = self.courseDescInput.value.trim();
        };
        self.coursePromoteInputBlur = function(){
            self.course.slogan = self.coursePromoteInput.value.trim();
        };
        self.courseMediaPriceInputBlur = function(){
            var listPrice = self.courseMediaPriceInput.value.trim();
            if(!listPrice){
                return self.validators.addToSet({
                    success: false,
                    field: '媒体价',
                    desc: '不能为空!',
                    key: 'courseMediaPrice'
                });
            }
            self.course.listPrice = listPrice;
        };
        self.onSelectMemberDiscountsType1 = function(e){
            self.course.memberDiscountsType = __app.enums.CommissionType.names.Cash;
            self.course.memberDiscountsValue = '';
            self.validators.pass('emptyMemberDiscountsValuePercent');
            self.validators.pass('membershipDiscountValue');
            self.validators.pass('membershipDiscountPercent');
            self.memberDiscountsValueInput1.value = "";
            self.memberDiscountsValueInput2.value = "";
            self.validators.addToSet({
                success: false,
                field: '请输入会员折扣金额',
                desc: '当前为空',
                key: 'emptyMemberDiscountsValueCash'
            });
            return true;
        };
        self.onSelectMemberDiscountsType2 = function(e){
            self.course.memberDiscountsType = __app.enums.CommissionType.names.Percent;
            self.course.memberDiscountsValue = '';
            self.validators.pass('emptyMemberDiscountsValueCash');
            self.validators.pass('membershipDiscountValue');
            self.validators.pass('membershipDiscountPercent');
            self.memberDiscountsValueInput1.value = "";
            self.memberDiscountsValueInput2.value = "";
            self.validators.addToSet({
                success: false,
                field: '请输入会员折扣百分比',
                desc: '当前为空',
                key: 'emptyMemberDiscountsValuePercent'
            });
            return true;
        };
        self.onSelectUpLine1CommissionType1 = function(e){
            self.course.upLine1CommissionType = __app.enums.CommissionType.names.Cash;
            self.course.upLine1CommissionValue = '';
            self.upLine1CommissionValueInput2.value = '';
            self.validators.pass('emptyUpLine1CommissionValuePercent');
            self.validators.pass('upLine1CommissionValue');
            self.validators.pass('upLine1CommissionPercent');
            self.validators.addToSet({
                success: false,
                field: '请输入直接分销商佣金金额',
                desc: '当前为空',
                key: 'emptyUpLine1CommissionValueCash'
            });
            return true;
        };
        self.onSelectUpLine1CommissionType2 = function(e){
            self.course.upLine1CommissionType = __app.enums.CommissionType.names.Percent;
            self.course.upLine1CommissionValue = '';
            self.upLine1CommissionValueInput1.value = '';
            self.validators.pass('upLine1CommissionValue');
            self.validators.pass('upLine1CommissionPercent');
            self.validators.pass('emptyUpLine1CommissionValueCash');
            self.validators.addToSet({
                success: false,
                field: '请输入直接分销商佣金百分比',
                desc: '当前为空',
                key: 'emptyUpLine1CommissionValuePercent'
            });
            return true;
        };
        self.onSelectUpLine2CommissionType1 = function(e){
            self.course.upLine2CommissionType = __app.enums.CommissionType.names.Cash;
            self.course.upLine2CommissionValue = '';
            self.upLine2CommissionValueInput2.value = '';
            self.validators.pass('emptyUpLine2CommissionValuePercent');
            self.validators.pass('upLine2CommissionValue');
            self.validators.pass('upLine2CommissionPercent');
            self.validators.addToSet({
                success: false,
                field: '请输入二级分销商佣金金额',
                desc: '当前为空',
                key: 'emptyUpLine2CommissionValueCash'
            });
            return true;
        };
        self.onSelectUpLine2CommissionType2 = function(e){
            self.course.upLine2CommissionType = __app.enums.CommissionType.names.Percent;
            self.course.upLine2CommissionValue = '';
            self.upLine2CommissionValueInput1.value = '';
            self.validators.pass('upLine2CommissionValue');
            self.validators.pass('upLine2CommissionPercent');
            self.validators.pass('emptyUpLine2CommissionValueCash');
            self.validators.addToSet({
                success: false,
                field: '请输入二级分销商佣金百分比',
                desc: '当前为空',
                key: 'emptyUpLine2CommissionValuePercent'
            });
            return true;
        };
        self.onSelectUpLine3CommissionType1 = function(e){
            self.course.upLine3CommissionType = __app.enums.CommissionType.names.Cash;
            self.course.upLine3CommissionValue = '';
            self.upLine3CommissionValueInput2.value = '';
            self.validators.pass('emptyUpLine3CommissionValuePercent');
            self.validators.pass('upLine3CommissionValue');
            self.validators.pass('upLine3CommissionPercent');
            self.validators.addToSet({
                success: false,
                field: '请输入三级分销商佣金金额',
                desc: '当前为空',
                key: 'emptyUpLine3CommissionValueCash'
            });
            return true;
        };
        self.onSelectUpLine3CommissionType2 = function(e){
            self.course.upLine3CommissionType = __app.enums.CommissionType.names.Percent;
            self.course.upLine3CommissionValue = '';
            self.upLine3CommissionValueInput1.value = '';
            self.validators.pass('upLine3CommissionValue');
            self.validators.pass('upLine3CommissionPercent');
            self.validators.pass('emptyUpLine3CommissionValueCash');
            self.validators.addToSet({
                success: false,
                field: '请输入三级分销商佣金百分比',
                desc: '当前为空',
                key: 'emptyUpLine3CommissionValuePercent'
            });
            return true;
        };
        var validateValue = function(val, kv, callback){
            if(val.trim() === "" || val.trim() < 0 || parseInt(val.trim(), 10) > parseInt(self.course.listPrice, 10)){
                return self.validators.addToSet({
                    success: false,
                    field: kv.value,
                    desc: '所属金额小于0,或者大于媒体价',
                    key: kv.key
                });
            }
            self.validators.pass(kv.key);
            callback();
        };
        var validatePercent = function(val, kv, callback){
            if(val.trim() <= 0 || val.trim() > 100){
                return self.validators.addToSet({
                    success: false,
                    field: kv.value,
                    desc: '请输入1到100的自然数',
                    key: kv.key
                });
            }
            self.validators.pass(kv.key);
            callback();
        };
        self.onValidateValue = function(e){
            self.validators.pass('emptyMemberDiscountsValueCash');
            self.validators.pass('membershipDiscountPercent');
            validateValue(e.target.value, {key: 'membershipDiscountValue', value: '会员折扣金额非法'}, function(){
                self.course.memberDiscountsValue = e.target.value;
            })
        };
        self.onValidatePercent = function(e){
            self.validators.pass('emptyMemberDiscountsValuePercent');
            self.validators.pass('membershipDiscountValue');
            validatePercent(e.target.value, {key: 'membershipDiscountPercent', value: '会员折扣百分比非法'}, function(){
                self.course.memberDiscountsValue = e.target.value;
            })
        };
        self.onBlurUpLine1CommissionValue = function(type){
            return function(e){
                if(type === 'val'){
                    self.validators.pass('emptyUpLine1CommissionValueCash');
                    self.validators.pass('upLine1CommissionPercent');
                    validateValue(e.target.value, {key: 'upLine1CommissionValue', value: '一级分销金额非法'}, function(){
                        self.course.upLine1CommissionValue = e.target.value;
                    });
                    return;
                }
                self.validators.pass('emptyUpLine1CommissionValuePercent');
                self.validators.pass('upLine1CommissionValue');
                validatePercent(e.target.value, {key: 'upLine1CommissionPercent', value: '一级分销百分比非法'}, function(){
                    self.course.upLine1CommissionValue = e.target.value;
                })
            }
        };

        self.onBlurUpLine2CommissionValue = function(type){
            return function(e){
                if(type === 'val'){
                    self.validators.pass('emptyUpLine2CommissionValueCash');
                    self.validators.pass('upLine2CommissionPercent');
                    validateValue(e.target.value, {key: 'upLine2CommissionValue', value: '二级分销金额非法'}, function(){
                        self.course.upLine2CommissionValue = e.target.value;
                    });
                    return;
                }
                self.validators.pass('emptyUpLine2CommissionValuePercent');
                self.validators.pass('upLine2CommissionValue');
                validatePercent(e.target.value, {key: 'upLine2CommissionPercent', value: '二级分销百分比非法'}, function(){
                    self.course.upLine2CommissionValue = e.target.value;
                })
            }
        };
        self.onBlurUpLine3CommissionValue = function(type){
            return function(e){
                if(type === 'val'){
                    self.validators.pass('emptyUpLine3CommissionValueCash');
                    self.validators.pass('upLine3CommissionPercent');
                    validateValue(e.target.value, {key: 'upLine3CommissionValue', value: '三级分销金额非法'}, function(){
                        self.course.upLine3CommissionValue = e.target.value;
                    });
                    return;
                }
                self.validators.pass('emptyUpLine3CommissionValuePercent');
                self.validators.pass('upLine3CommissionValue');
                validatePercent(e.target.value, {key: 'upLine3CommissionPercent', value: '三级分销百分比非法'}, function(){
                    self.course.upLine3CommissionValue = e.target.value;
                })
            }
        };

        self.onFileChange = function(e){
            var file = document.getElementById("posterInput").files[0];
            if(file.size > 2*1024*1024){
                alert("文件大小超过限制-2M");
                return;
            }
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e){
                self.course.poster = {
                    file: file,
                    data: e.target.result
                };
                self.update();
            };
        };

        self.removeBanner = function(e){
            self.course.banners.map(function(banner, i){
                if(banner
                    && banner.file
                    && banner.file.name
                    && e.item.banner
                    && e.item.banner.file
                    && e.item.banner.file.name){

                    if(banner.file.name === e.item.banner.file.name){
                        self.course.banners.splice(i, 1)
                    }
                    return;
                }

                if(banner === e.item.banner){
                    self.course.banners.splice(i, 1);
                }
            });
        };

        self.onBannersChange = function(e){
            var files = document.getElementById("bannersInput").files;

            if(self.course.banners){
                if(self.course.banners.length + files.length > maxBannerCount){
                    alert('焦点图最多' + maxBannerCount + '张');
                    return;
                }
            }else if(files.length > maxBannerCount){
                alert('焦点图最多' + maxBannerCount + '张');
                return;
            }
            if(files && files.length){
                var index = 0;
                var loadRecur = function(index){
                    var file = files[index];
                    if(!file){
                        return;
                    }
                    if(file.size > 2*1024*1024){
                        alert("文件大小超过限制-2M");
                        return;
                    }
                    var reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function(e){
                        if(!self.course.banners){
                            self.course.banners = [];
                        }
                        self.course.banners.push({
                            file: file,
                            data: e.target.result
                        });
                        self.update();
                        loadRecur(++index)
                    };
                };
                loadRecur(index)
            }
        };

        self.onSubmit = function(){
            var totalTasksNum = 0;
            var completelyTasksNum = 0;
            self.course.memberDiscountsValue = self.course.memberDiscountsValue || 0;
            self.course.upLine1CommissionValue = self.course.upLine1CommissionValue || 0;
            self.course.upLine2CommissionValue = self.course.upLine2CommissionValue || 0;
            self.course.upLine3CommissionValue = self.course.upLine3CommissionValue || 0;
            var req = {
                id: self.course._id,
                o: self.course
            };
            if(self.course.poster && self.course.poster.file){
                ++totalTasksNum;
                var formData1 = new FormData();
                formData1.append('file', self.course.poster.file);
                $.ajax({
                    url: __app.settings.api.url + '/file/upload',
                    type: 'POST',
                    data: formData1,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        req.o.poster = res.media_id;
                        ++completelyTasksNum;
                        done();
                    },
                    error: function (responseStr) {
                        console.error("失败:" + JSON.stringify(responseStr));
                    }
                });
            }

            if(self.course.banners){
                ++totalTasksNum;
                var formData2 = new FormData();
                self.course.banners.map(function(banner){
                    if(banner.file){
                        formData2.append('files', banner.file);
                    }
                });

                $.ajax({
                    url: __app.settings.api.url + '/file/uploads',
                    type: 'POST',
                    data: formData2,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        var persistedBanners = [];
                        if(self.course.banners && self.course.banners.length){
                            persistedBanners = self.course.banners.filter(function(banner){
                                return typeof banner === 'string'
                            });
                        }
                        req.o.banners = persistedBanners.concat(res.metas.map(function(meta){return meta.media_id}));
                        ++completelyTasksNum;
                        done();
                    },
                    error: function (responseStr) {
                        console.error("失败:" + JSON.stringify(responseStr));
                    }
                });
            }

            done();

            function done(){
                if(completelyTasksNum != totalTasksNum){
                    return;
                }
                updateCourseByIdAction.newInvocation(req)
                    .onDone(function(res){
                        riot.route('sd/courses');
                    })
                    .execute();
            }

        };
    </script>
</boss-tenant-sd-courses-edit>