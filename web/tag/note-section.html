<note-section>
    <div class="page-action-bar" if="{isShowShareBtnGroup()}">
        <div onclick="{onShareItems}" class="save pull-right">分享</div>
        <div onclick="{onCancelShare}" class="cancel pull-right">取消</div>
    </div>
    <div class="page {highlight: opts.highlight}" if="{!hidden}">
    <div class="section" sectionId="{_id}">
        <div class="panel">
        <div class="top-padding" />
        <div class="author">
            <div style="display: inline; float: left;">
                <img class="user-icon" riot-src="{section.initiator.headimgurl}"/>
            </div>
            <div style="display: inline; float: left; padding-left: 10px;">
                <label class="user-nickname"> {initiator.nickname}</label>
            </div>
            <div style="display: inline; float: left; padding-left: 10px;">
                <span if="{section.parentNote && section.status != 'dr'}">{formatDate(new Date(section.crtOn))}</span>
            </div>
        </div>
        <div class="noteItems">
            <div class="{share_div: parent.inShareItems(note)}" each="{note in section.mates}" noteId="{_id}" style="position:relative;z-index: 3;margin-top: 5px" onclick="{parent.deleteNote}">
                <div if="{note.type==='txt'}" class="note-text">{note.content}</div>
                <div if="{note.type==='img'}" class="note_img"><img style="width: 100%" riot-src="{note.url}"/></div>
                <div if="{note.type==='voi'}" class="note-voice" style="float:left">
                    <div style="width: {seconds * 3 + 30}px" class="voice-bubble left" onclick="{parent.playVoice}" >
                        <img src="/public/images/voice_3.png">
                    </div><span class="seconds">{note.seconds}"</span>
                </div>
                <div style="clear: both;"></div>
            </div>
        </div>

        <div class="bottom">
            <table style="width:100%;" cellpadding="0" cellspacing="0">
                <tr>
                    <td style="width:45%;">
                    </td>
                    <td style="width:10%;">
                        <div class="img-btn left" if="{!isOnEdit() && (section.initiator._id === parent.user._id)}">

                        </div>
                    </td>
                </tr>
            </table>
        </div>

        </div>
        <div class="bottom-padding" />
    </div>
    </div>
    <style scoped>
        .share_div{
            background: red;
        }
        .highlight{
            background: red;
        }
        label{
            font-size: 14px;
        }
        .interact_box{
            line-height: 40px;
            border-top: 1px solid #ddd;
        }
        .interact_box .comments img{
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50em;
            vertical-align: middle;
        }

        .noteItems div{
            line-height: 42px;
        }
        .noteItems div .note_img{
            width:100%;
        }
        .note_section{
            width: 94%;
            border: 1px solid #ddd;
            margin: 15px auto;
            background: white;
            padding: 10px;
            padding-bottom: 0px;
            font-size: 14px;
        }
        .note_section .featureArea{
            margin-top: 10px;
            position: relative;
        }
        .note_section .featureArea .send_btn{
            display: block;
            float: right;
            height: 32px;
        }
        .note_section textarea{
            height: 32px;
            line-height: 32px;
            position: absolute;
            bottom: 2px;
            margin: 0px auto;
            left: 50px;
            display: block;
            width: -webkit-calc(100% - 100px);
            width: -moz-calc(100% - 100px);
            width: calc(100% - 100px);
            border: none;
            border-bottom: 1px solid #18c54b;
            font-size: 14px;
        }
        .voice{
            margin-left: 10px;
            float: left;
            background-color: #ffffff;
            border-radius: 7px;
            border: 1px solid #c4c4c4;
        }
        .seconds{
            float: left;
            font-size: 12px;
            margin-left: 5px;
        }
        .playIcon{
            background: url('/web/images/wx-icon.png') 0 -2428px;
            background-size: 150px 2489px;
            width: 16px;
            height: 16px;
            vertical-align: middle;
            display: inline-block;
        }
    </style>
    <script>
        //private properties
        var self = this;
        var saveNoteInSection = domain.action('saveNoteInSection');
        var updateNote = domain.action('updateNote');
        var deleteNotes = domain.action('deleteNotes');
        var publishNote = domain.action('publishNote');
        var saveNotesInSection = domain.action('saveNotesInSection');
        var uploadImage = domain.action('uploadImage');
        var uploadVoice = domain.action('uploadVoice');
        var likeNote = domain.action('likeNote');
        var unlikeNote = domain.action('unlikeNote');
        var deleteComment = domain.action('deleteComment');

        //instance properties
        self.section = this.opts.section;
        self.parent = self.parent.parent;
        self.initiator = self.section.initiator || self.parent.user;
        self.initiator.headimgurl = self.initiator.headimgurl || '/public/images/def-avatar.png';
        self.isOnEdit = function(){
            return self.parent.currNote === self.section;
        };
        self.inShareItems = function(note){
            return self.opts.shares && (self.opts.shares.filter(function(i){ return i._id===note._id}).length>0) || null
        };
        self.viewModel = {
            toggleTxtVoiBtn: {
                txt: true,
                voi: false,
                toggle: function(){
                    var me = self.viewModel.toggleTxtVoiBtn;
                    me.txt = !me.txt;
                    me.voi = !me.voi;
                }
            },
            input: {
                wait: true,
                editTxt: false,
                doWait: function(){
                    this.wait = true;
                    this.editTxt = false;
                },
                doEdit: function(){
                    this.wait = false;
                    this.editTxt = true;
                }
            }
        };
        //instance methods
        self.init = function(){
        };
        self.formatDate = util.formatDateForComments;
        self.on('update', function(){
            self.section = self.opts.section;
        });
        self.isShowShareBtnGroup = function(){
            return self.opts.mode === 'share' && (self.initiator._id === self.parent.user._id);
        };
        self.deleteNote = function(e){
//            if(!(self.isOnEdit() && (self.initiator._id === self.parent.user._id))){
//                return false;
//            }
            if(self.opts.mode === 'share'){
                return app.trigger('shareToggle', e.item.note);
            }
            self.confirm({text: '是否删除该行'}, function(){
                deleteNotes.newInvocation({
                    notes: [e.item._id]
                })
                .onDone(function(data){
                    if(data.success){
                        self.section.mates.forEach(function(mate, index){
                            if(mate._id === e.item._id){
                                self.section.mates.splice(index, 1);
                            }
                        });
                        self.update();
                    }
                    else{
                        alert(data.error);
                    }
                })
                .execute();
            });
        };
        self.onCancelShare = function(e){
            app.trigger('viewMode');
        };
        self.onShareItems = function(e){
            app.trigger('beginShare');
        };
        self.confirm = function(option, fn){
            app.one('confirm', confirmListener);
            app.one('cancel', cancelListener);
            function confirmListener(){
                clearListeners();
                fn();
            }
            function cancelListener(){
                clearListeners();
            }
            function clearListeners(){
                app.off('confirm', confirmListener);
                app.off('cancel', cancelListener);
            }
            app.trigger('popUp', option);
        };
        self.playVoice = function (e) {
            var data = e.item;
            self.parent.trigger('playVoice', data.url, data.status);
            e.stopPropagation();
        }

    </script>
</note-section>