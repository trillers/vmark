<note-section>
    <div class="section" sectionId="{_id}">
        <div class="panel">
        <div class="top-padding" />
        <div class="author" >
            <div style="display: inline; float: left;">
                <img class="user-icon" riot-src="{initiator.headimgurl}"/>
            </div>
            <div style="display: inline; float: left; padding-left: 10px;">
                <label class="user-nickname"> {initiator.nickname}</label>
            </div>
            <div style="display: inline; float: left; padding-left: 10px;">
                <span if="{section.parentNote && section.status != 'dr'}">{formatDate(new Date(section.crtOn))}</span>
            </div>
        </div>

        <div class="top" >
            <label class="btn active" onclick="{submitSectionNote}" if="{isOnEdit() && (initiator._id === parent.user._id)}" >确定</label>
            <label class="btn" onclick="{cancelSectionNote}" if="{isOnEdit() && (initiator._id === parent.user._id)}" >取消</label>
            <input class="btn" onclick="{clearTrash}" if="{isOnEdit() && trash.length>0}" value="删除" type="button" class="send_btn weui_btn weui_btn_mini weui_btn_warn"/>
        </div>

        <div class="noteItems">
            <div each="{section.mates}" noteId="{_id}" style="margin-top: 2px">
                <div onclick="{parent.pushToTrash}" if="{parent.isOnEdit()}" style="float: left">
                    <b class="{weui_icon_cancel : parent.inTrash(_id), weui_icon_circle: !parent.inTrash(_id)}"></b>
                </div>
                <div if="{type==='txt'}" class="note_txt">{content}</div>
                <div if="{type==='img'}" class="note_img"><img style="width: 100%" src="{url}"/></div>
                <div if="{type==='voi'}" class="note_voi" style="float:left"><div style="width: {seconds * 3 + 30}px" class="voice" onclick="{parent.playVoice}"><i class="playIcon"></i></div><span class="seconds">{seconds}"</span></div>
                <div style="clear: both;"></div>
            </div>
        </div>

        <div class="bottom">
            <table style="width:100%;" cellpadding="0" cellspacing="0">
                <tr>
                    <td style="width:50%;">
                        <div class="img-btn left">
                            <img src="/public/images/append.png">
                        </div>
                        <div class="img-btn left" onclick="{editSectionNote}" if="{!isOnEdit() && (initiator._id === parent.user._id)}">
                            <img src="/public/images/edit.png">
                        </div>
                    </td>
                    <td style="width:50%;">
                        <div class="right">
                            <div id="interactBlock" class="left" style="display: inline-block; height: 24px;">
                                <div onclick="{like}" class="img-btn left">
                                    <img src="/public/images/like.png">
                                </div>
                                <div onclick="{comment}" class="img-btn left" style="display: inline-block; ">
                                    <img src="/public/images/comment.png">
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        </div>

        <div class="interact" if="{!isNew}">
            <div class="likes" >
                <ul>
                    <li each="{section.likes}">
                        <div><img class="user-icon" riot-src="{initiator.headimgurl}"/></div>
                    </li>
                </ul>
            </div>
            <div class="comments" if="{parent.currComment._id === section._id}">
                <ul>
                    <li each="{section.comments}" onclick="{parent.deleteComment}">
                    <table style="width:100%;" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="width: 24px;">
                                <div>
                                    <img class="user-icon" src="{initiator.headimgurl}"/>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <span>{content}</span>
                                </div>
                            </td>
                            <td style="width: 20px; ">
                                <div>
                                    <img class="small-icon" src="/public/images/trashbin.png"/>
                                </div>
                            </td>
                            <td style="width: 60px;">
                                <div>
                                    <span style="font-size: 12px; float:right">{parent.formatDate(new Date(crtOn))}</span>
                                </div>
                            </td>
                        </tr>
                    </table>
                    </li>
                </ul>
            </div>
        </div>
        <div class="bottom-padding" />
    </div>
    <style scoped>
        label{
            font-size: 14px;
        }
        .interact_box{
            line-height: 40px;
            border-top: 1px solid #ddd;
        }
        .interact_box .comments img{
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50em;
            vertical-align: middle;
        }

        .noteItems div{
            line-height: 31px;
        }
        .noteItems div .note_img{
            width:100%;
        }
        .note_section{
            width: 94%;
            border: 1px solid #ddd;
            margin: 15px auto;
            background: white;
            padding: 10px;
            padding-bottom: 0px;
            font-size: 14px;
        }
        .note_section .featureArea{
            margin-top: 10px;
            position: relative;
        }
        .note_section .featureArea .send_btn{
            display: block;
            float: right;
            height: 32px;
        }
        .note_section textarea{
            height: 32px;
            line-height: 32px;
            position: absolute;
            bottom: 2px;
            margin: 0px auto;
            left: 50px;
            display: block;
            width: -webkit-calc(100% - 100px);
            width: -moz-calc(100% - 100px);
            width: calc(100% - 100px);
            border: none;
            border-bottom: 1px solid #18c54b;
            font-size: 14px;
        }
        .voice{
            margin-left: 10px;
            float: left;
            background-color: #04BE02;
            border-radius: 7px;
        }
        .seconds{
            float: left;
            font-size: 12px;
            margin-left: 5px;
        }
        .playIcon{
            background: url('/web/images/wx-icon.png') 0 -2428px;
            background-size: 150px 2489px;
            width: 23px;
            height: 23px;
            vertical-align: middle;
            display: inline-block;
        }
    </style>
    <script>
        //private properties
        var self = this;
        var saveNoteInSection = domain.action('saveNoteInSection');
        var updateNote = domain.action('updateNote');
        var deleteNotes = domain.action('deleteNotes');
        var publishNote = domain.action('publishNote');
        var saveNotesInSection = domain.action('saveNotesInSection');
        var uploadImage = domain.action('uploadImage');
        var uploadVoice = domain.action('uploadVoice');
        var likeNote = domain.action('likeNote');
        var unlikeNote = domain.action('unlikeNote');
        var deleteComment = domain.action('deleteComment');
        //instance properties
        self.section = this.opts.section;
        self.isNew = !!this.opts.new;
        self.parent = self.isNew ? self.parent : self.parent.parent;
        self.confirmComponent  = self.parent.tags['note-confirm'];
        self.initiator = self.section.initiator || self.parent.user;
        self.initiator.headimgurl = self.initiator.headimgurl || '/public/images/def-avatar.png';
        self.isOnEdit = function(){
            if(self.isNew){
                return !self.section.parentNote || (self.section.parentNote && self.section.status === 'dr')
            }
            return self.parent.currNote === self.section;
        };
        self.trash = [];
        self.inTrash = function(id){
            return (function lambda(arr){
                if(arr[0]._id === id) return true;
                    if(arr.slice(1).length>0) return lambda(arr.slice(1));
                        return false;
            })(self.trash);
        };
        self.viewModel = {
            toggleTxtVoiBtn: {
                txt: true,
                voi: false,
                toggle: function(){
                    var me = self.viewModel.toggleTxtVoiBtn;
                    me.txt = !me.txt;
                    me.voi = !me.voi;
                }
            },
            input: {
                wait: true,
                editTxt: false,
                doWait: function(){
                    this.wait = true;
                    this.editTxt = false;
                },
                doEdit: function(){
                    this.wait = false;
                    this.editTxt = true;
                }
            }
        };
        //instance methods
        self.init = function(){
            if(self.isNew){
                self.section = {
                    mates: []
                }
            }
            self.trash = [];
        };
        self.formatDate = util.formatDateForComments;
        self.on('update', function(){
            self.section = self.opts.section;
        });
        self.pushToTrash = function(e){
            if(self.trash.length<=0){
                self.trash.push(e.item);
                return
            }
            self.trash.forEach(function(t, index){
                if(t._id === e.item._id){
                    self.trash.splice(index, 1);
                }else if(index === self.trash.length-1){
                    self.trash.push(e.item);
                }
            });
        };
        self.editSectionNote = function(e){
            self.init();
            self.parent.selectNote(self.section);
        };
        self.clearTrash = function(){
            var ids = self.trash.map(function(note){
                return note._id;
            });
            deleteNotes.newInvocation({
                        notes: ids
                    })
                    .onDone(function(data){
                        if(data.success){
                            self.section.mates = self.section.mates.filter(function(note){
                                for(var i= 0, len=self.trash.length; i<len; i++){
                                    if(self.trash[i]._id === note._id){
                                        return false;
                                    }
                                }
                                return true;
                            });
                            self.trash = [];
                            self.update();
                        }
                        else{
                            alert(data.error);
                        }
                    })
                    .execute();
        };
        self.deleteComment = function(e){
            var commenter = e.item.initiator;
            if(commenter._id != self.parent.user._id){
                return false;
            }
            self.confirmComponent.one('confirm', confirmListener);
            self.confirmComponent.one('cancel', cancelListener);
            function confirmListener(){
                clearListeners();
                deleteComment
                    .newInvocation({
                        id: e.item._id
                    })
                    .onDone(function(data){
                        if(data.success){
                            self.section.comments.forEach(function(comment, index){
                                if(comment._id == e.item._id){
                                    self.section.comments.splice(index, 1);
                                }
                                self.update();
                            })
                        }else{
                            alert('delete comments failed.')
                        }
                    })
                    .execute();
            }
            function cancelListener(){
                clearListeners();
            }
            function clearListeners(){
                self.confirmComponent.off('confirm', confirmListener);
                self.confirmComponent.off('cancel', cancelListener);
            }
            self.confirmComponent.trigger('popUp');
        };
        self.cancelSectionNote = function(e){
            self.init();
            self.parent.trigger('cancel', self.section);
        };
        self.submitSectionNote = function(e){
            if(!self.section._id
                    || (self.section && self.section.mates && self.section.mates.length <=0)){
                return;
            }
            if(self.trash.length>0){
                var ids = self.trash.map(function(note){
                    return note._id;
                });
                deleteNotes.newInvocation({
                    notes: ids
                })
                .onDone(function(data){
                    if(data.success){
                        clearTrashDone();
                    }
                    else{
                        alert(data.error);
                    }
                })
                .execute();
            }else{
                clearTrashDone();
            }
            function clearTrashDone(){
                self.section.mates = self.section.mates.filter(function(note){
                    for(var i= 0, len=self.trash.length; i<len; i++){
                        if(self.trash[i]._id === note._id){
                            return false;
                        }
                    }
                    return true;
                });
                if(self.section.mates.length<=0){
                    self.init();
                    self.parent.trigger('noteSubmit', self.section);
                    return;
                }
                var index = 0;
                self.section.mates.forEach(function(mate){
                    if(!mate.status || mate.status === 'dr'){
                        if(mate.type === 'img' && mate.url){
                            wx.uploadImage({
                                localId: mate.url,
                                isShowProgressTips: 0,
                                success: function(res){
                                    uploadImage.newInvocation({media_id: res.serverId})
                                        .onDone(function(data){
                                            mate.url = data.url;
                                            if(++index === self.section.mates.length){
                                                submitWholeSection();
                                            }
                                        })
                                        .execute();
                                }
                            })
                        }
                        else if(mate.type=== 'voi' && mate.url){
                            wx.uploadVoice({
                                localId: mate.url,
                                isShowProgressTips: 0,
                                success: function(res){
                                    uploadVoice.newInvocation({media_id: res.serverId})
                                        .onDone(function(data){
                                            mate.url = data.url;
                                            if(++index === self.section.mates.length){
                                                submitWholeSection();
                                            }
                                        })
                                        .execute();
                                }
                            })
                        }
                        else{
                            if(++index === self.section.mates.length){
                                submitWholeSection();
                            }
                        }
                    }else{
                        if(++index === self.section.mates.length){
                            submitWholeSection();
                        }
                    }
                });
            }
            function submitWholeSection(){
                publishNote.newInvocation(self.section)
                    .onDone(function(data){
                        try {
                            util.mixin(self.section, data);
                            if(self.isNew){
                                self.parent.pageNote.mates.push(self.section);
                            }
                            self.init();
                            self.parent.trigger('noteSubmit', self.section);
                        } catch (e){
                            alert(JSON.stringify(e))
                        }
                    })
                    .execute();
            }
        };
        self.comment = function(e){
            self.parent.trigger('comment', self.section);
        };
        self.like = function(e){
            var currLike = null;
            if(self.section.likes.length>0){
                //liked or not
                self.section.likes.forEach(function(like){
                    if(like.initiator._id === self.parent.user._id){
                        currLike = like;
                    }
                })
            }
            if(currLike){
                unlikeNote
                    .newInvocation({
                        interaction: currLike._id,
                        note: self.section._id
                    })
                    .onDone(function(data){
                        if(data.success){
                            self.section.likes = self.section.likes.filter(function(item){
                                return item.initiator._id != self.parent.user._id;
                            });
                            self.update();
                        }
                        else{
                            alert('failed to unlike item');
                        }
                    })
                    .execute();
            }else{
                likeNote
                    .newInvocation({
                        interaction: {
                            initiator: self.parent.user._id
                        },
                        note: self.section._id
                    })
                    .onDone(function(data){
                        if(data && data.like){
                            self.section.likes.push(data.like);
                            self.update();
                        }
                        else{
                            alert('failed to like item');
                        }
                    })
                    .execute();
            }

        };
        self.playVoice = function (e) {
            var data = e.item;
            self.parent.trigger('playVoice', data.url, data.status);
        }
    </script>
</note-section>