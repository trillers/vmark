<note-edit>
    <div if="{!hidden}">
        <note-menu></note-menu>
        <div class="wrapper">
            <div>
                <input class="title" onblur="{updatePageNote}" type="text" value="{pageNote.title}" placeholder="添加标题" name="titleInput"/>
                <hr style="margin-bottom: 10px"/>
            </div>
            <div>
                <img style="width:32px;height:32px" src="/public/images/111.jpeg"/>
                <label>包三哥</label>
                <span>{formatDate(new Date())}</span>
            </div>
            <div>
                <note-section each="{pageNote.mates}" section="{this}"></note-section>
                <note-section section="{newSection}" if="{viewModel.EDIT}"></note-section>
                <ul class="btn-group" onclick="{selectOperate}">
                    <li><a class="weui_btn weui_btn_mini weui_btn_primary">文字</a></li>
                    <li><a class="weui_btn weui_btn_mini weui_btn_primary">图片</a></li>
                    <li><a class="weui_btn weui_btn_mini weui_btn_primary">语音</a></li>
                    <li><a class="weui_btn weui_btn_mini weui_btn_primary">小视频</a></li>
                </ul>
            </div>
            <div>
                <span if="{pageNote.parentNote}">{pageNote.txt}</span>
            </div>
        </div>
        <style scoped>
            :focus{
                outline: none;
            }
            .wrapper{
                padding: 10px;
            }
            .title{
                font-size: 16px;
                display: inline-block;
                height:30px;
                line-height: 30px;
                background: transparent;
                border: none;
            }
            .note_items div{
                height: 40px;
                line-height: 40px;
            }
            body{
                font-size: 14px;
            }
            .btn-group li{
                float:left;
                padding:10px;
            }
        </style>
        <script>
            "use strict";
            //private properties
            var self = nest.presentable(this);
            var loadNote = domain.action('loadNote');
            var updateNote = domain.action('updateNode');
            var onLoadNote = function(data){
                if(data){
                    self.pageNote = data;
                }
                self.trigger('ready', false);
                self.trigger('view-route-to');
                self.update();
            };
            //instance properties
            self.pageNote = null;
            self.newSection = {};
            self.newSection.mates = [];
            self.viewModel = {
                'EDIT': false,
                'VIEW': false,
                doEdit: function(){
                    self.viewModel.EDIT = true;
                    self.viewModel.VIEW = false;
                },
                doView: function(){
                    self.viewModel.EDIT = false;
                    self.viewModel.VIEW = true;
                }
            };
            //instance methods
            self.formatDate = function(date){
                return new Date(date).toLocaleString();
            };
            self.formatDateForMates = util.formatDateForComments;
            self.init = function(){
                self.pageNote = {
                    title: null,
                    comments: null,
                    crtOn: null,
                    _id: null
                };
                self.titleInput.value = '';
                wx.onMenuShareTimeline({
                    title: '测试分享主题',
                    link: getLink(),
                    imgUrl: '',
                    success: function(){

                    },
                    cancel: function(){

                    }
                });
                function getLink(){
                }
            };
            self.updatePageNote = function(e){
                var title = e.currentTarget.value;
                if(!title){
                    return;
                }
                updateNote.execute({
                    id: self.pageNote._id,
                    title: title
                });
            };
            self.selectOperate = function(e){
                if(e.target.nodeName === 'A'){
                    var liNode = e.target;
                    self.viewModel.doEdit();
                    self.update();
                }
            };
            self.on('mount', function(){
                loadNote.onDone(onLoadNote);
            });
            self.on('unmount', function(){
                loadNote.offDone(onLoadNote);
            });
            self.on('open', function(options){
                self.init();
                try{
                    self.pageNote._id = window.location.pathname.match(/_(\w+)/g)[0].substr(1);
                }catch(e){
                    alert('无效的链接');
                }
                console.info('tag pageNote new is opening');
                 loadNote.execute({
                    noteId: self.pageNote._id
                });
            });
            self.on('leave', function(){
                self.mask = true;
                self.update();
            });
            self.on('reenter', function(){
                self.mask = false;
                self.update();
            });
            self.on('refresh', function(){
                console.info('tag group index is refreshing');
                //_refresh();
            });
        </script>
    </div>
</note-edit>