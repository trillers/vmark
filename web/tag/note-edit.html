<note-edit>
    <div if="{!hidden}">
        <note-menu></note-menu>
        <div>
            <input onblur="{updatePageNote}" type="text" value="{pageNote.title}" placeholder="添加标题" name="titleInput"/>
            <hr/>
        </div>
        <div>
            <img style="width:32px;height:32px" src="/public/images/111.jpeg"/>
            <label>包三哥</label>
            <span>{formatDate(new Date())}</span>
        </div>
        <div>
            <note-section each="{pageNote.mates}" section="{this}"></note-section>
            <note-section section="{newSection}" if="{viewModel.EDIT}"></note-section>
            <ul class="btn-group" onclick="{selectOperate}">
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">文字</a></li>
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">图片</a></li>
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">语音</a></li>
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">小视频</a></li>
            </ul>
        </div>
        <div>
            <span if="{pageNote.parent}">{pageNote.txt}</span>
        </div>
        <style>
            .note_items div{
                height: 40px;
                line-height: 40px;
            }
            body{
                font-size: 14px;
            }
            .btn-group li{
                float:left;
                padding:10px;
            }
        </style>
        <script>
            "use strict";
            var self = nest.presentable(this);
            var loadNote = domain.action('loadNote');
            var updateNote = domain.action('updateNode');
            self.newSection = {};
            self.newSection.mates = [];
            self.viewModel = {
                'EDIT': false,
                'VIEW': false,
                doEdit: function(){
                    self.viewModel.EDIT = true;
                    self.viewModel.VIEW = false;
                },
                doView: function(){
                    self.viewModel.EDIT = false;
                    self.viewModel.VIEW = true;
                }
            };
            self.formatDate = function(date){
                var dateStr = new Date(date).toLocaleString();
                return dateStr;
            };
            self.formatDateForMates = util.formatDateForComments;
            self.pageNote = null;
            self.init = function(){
                self.pageNote = {
                    title: null,
                    comments: null,
                    crtOn: null,
                    _id: null
                };
                self.titleInput.value = '';
                wx.onMenuShareTimeline({
                    title: '测试分享主题',
                    link: getLink(),
                    imgUrl: '',
                    success: function(){

                    },
                    cancel: function(){

                    }
                });
                function getLink(){
                }
            };
            updatePageNote(e){
                var title = e.currentTarget.value;
                if(!title){
                    return;
                }
                updateNote.execute({
                    id: self.pageNote._id,
                    title: title
                });
            }
            selectOperate(e){
                if(e.target.nodeName === 'A'){
                    var liNode = e.target;
                    self.viewModel.doEdit();
                    self.update();
                }
            }
            function onLoadNote(data){
                if(data){
                    self.pageNote = data;
                }
                self.trigger('ready', false);
                self.trigger('view-route-to');
                self.update();
            }
            this.on('mount', function(){
                loadNote.onDone(onLoadNote);
            });
            this.on('unmount', function(){
                loadNote.offDone(onLoadNote);
            });
            this.on('open', function(options){
                self.init();
                try{
                    self.pageNote._id = window.location.pathname.match(/_(\w+)/g)[0].substr(1);
                    console.log(self.pageNote._id)
                }catch(e){
                    alert('无效的链接');
                }
                console.info('tag pageNote new is opening');
                 loadNote.execute({
                    noteId: self.pageNote._id
                });
            });

            this.on('leave', function(){
                self.mask = true;
                self.update();
            });

            this.on('reenter', function(){
                self.mask = false;
                self.update();
            });

            this.on('refresh', function(){
                console.info('tag group index is refreshing');
                //_refresh();
            });
        </script>
    </div>
</note-edit>