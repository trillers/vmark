<note-edit>
    <div if="{!hidden}">
        <note-menu></note-menu>
        <div class="xx">
            <input if="{!note.parent}" type="text" placeholder="添加标题" name="titleInput"/>
            <label if="{note.parent}">{note.title}</label>
            <hr/>
        </div>
        <div>
            <img style="width:32px;height:32px" src="/public/images/111.jpeg"/>
            <label>包三哥</label>
            <span>{formatDate(new Date())}</span>
        </div>
        <div>
            <div if="{state.EDIT}" class="note_section">
                <div style="line-height: 48px;height:48px;border-bottom: 1px solid #ddd;margin-bottom: 20px">
                    <img style="width:32px;height:32px" src="/public/images/111.jpeg"/>&nbsp&nbsp
                    <label>包三哥</label> &nbsp&nbsp
                    <span>{formatDate(new Date())}</span>
                </div>
                <div class="note_items">
                    <div class="note_item" each="{tmpNodes}" id="{_id}">
                        <div if="{txt}" class="">{txt}</div>
                        <div if="{img}" class="">{img}</div>
                        <div if="{voi}" class="">{voi}</div>
                    </div>
                </div>
                <div class="featureArea">
                    <input onclick="{viewModel.toggleTxtVoiBtn.toggle}" class="toggleBtn_txt_voi" />
                    <textarea if="{viewModel.toggleTxtVoiBtn.txt}" oninput="{noteEditInput}" placeholder="点击添加文字..." type="text" name="txtInput"></textarea>
                    <input if="{viewModel.toggleTxtVoiBtn.voi}" class="recordBtn" type="button" value="按住  说话"/>
                    <input if="{viewModel.input.editTxt}" onclick="{addItem}" class="send_btn weui_btn weui_btn_mini weui_btn_primary" type="button" value="发送"/>
                    <input if="{viewModel.input.wait}" class="menuBtn"/>
                </div>
            </div>
            <ul class="btn-group" onclick="{selectOperate}">
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">文字</a></li>
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">图片</a></li>
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">语音</a></li>
                <li><a class="weui_btn weui_btn_mini weui_btn_primary">小视频</a></li>
            </ul>

        </div>
        <div>
            <span if="{note.parent}">{note.txt}</span>
        </div>
        <ul each="{note.mates}">
            <li>{txt}</li>
            <li>{user.name}</li>
            <li>{parent.formatDate(crtOn)}</li>
        </ul>
        <note-footer cmds="{footerCmds}"></note-footer>
        <style>
            .note_items div{
                height: 40px;
                line-height: 40px;
            }
            body{
                font-size: 14px;
            }
            .btn-group li{
                float:left;
                padding:10px;
            }
            .note_section{
                width: 80%;
                border: 1px solid #ddd;
                margin: 15px auto;
                background: white;
                padding: 10px;
            }
            .note_section .featureArea{
                position: relative;
            }
            .note_section .featureArea .send_btn{
                display: block;
                float: right;
                height: 32px;
            }
            .note_section textarea{
                height: 32px;
                line-height: 32px;
                position: absolute;
                bottom: 2px;
                margin: 0px auto;
                left: 50px;
                display: block;
                width: -webkit-calc(100% - 100px);
                width: -moz-calc(100% - 100px);
                width: calc(100% - 100px);
                border: none;
                border-bottom: 1px solid #18c54b;
                font-size: 14px;
            }
            .headimg_size_m{
                width: 48px;
                height: 48px;
            }
            .recordBtn{
                position: absolute;
                bottom: 2px;
                margin: 0px auto;
                left: 50px;
                display: block;
                width: -webkit-calc(100% - 100px);
                width: -moz-calc(100% - 100px);
                width: calc(100% - 100px);
                border: 1px solid #b2b2b2;
                height: 32px;
                color: #888;
                line-height: 32px;
                background: none;
                border-radius: 3px;
                font-size: 14px;
            }
            .toggleBtn_txt_voi{
                width: 32px;
                height: 32px;
                border-radius: 50em;
                border: 1px solid #ddd;
            }
            .menuBtn{
                width: 32px;
                height: 32px;
                border-radius: 50em;
                border: 1px solid #ddd;
                display: block;
                float: right;
            }
        </style>
        <script>
            "use strict";
            var self = nest.presentable(this);
            var loadNote = domain.action('loadNote');
            var saveNote = domain.action('saveNote');
            self.tmpNodes = [];
            self.viewModel = {
                toggleTxtVoiBtn: {
                    txt: true,
                    voi: false,
                    toggle: function(){
                        var me = self.viewModel.toggleTxtVoiBtn;
                        me.txt = !me.txt;
                        me.voi = !me.voi;
                    }
                },
                input: {
                    wait: true,
                    editTxt: false,
                    doWait: function(){
                        this.wait = true;
                        this.editTxt = false;
                    },
                    doEdit: function(){
                        this.wait = false;
                        this.editTxt = true;
                    }
                }
            };
            self.formatDate = function(date){
                var dateStr = new Date(date).toLocaleString();
                console.log(dateStr);
                return dateStr;
            };
            noteEditInput(e){
                var txtVal = e.currentTarget.value.trim();
                if(txtVal){
                    self.viewModel.input.doEdit();
                }else{
                    self.viewModel.input.doWait();
                }

            }
            selectOperate(e){
                if(e.target.nodeName === 'A'){
                    var liNode = e.target;
                    self.state.EDIT = true;
                }
            }
            addItem(e){
                if(self.txtInput.value.trim() === ''){
                    return;
                }
                //execute restful api
                self.tmpNodes.push({
                    txt: self.txtInput.value
                });
                self.txtInput.value = '';
            }
            self.formatDateForMates = util.formatDateForComments;
            self.note = null;
            self.state = {
                'EDIT': false,
                'VIEW': false
            };
            //method
            self.save = function(){
                if(self && self.note && !self.note.parent && !self.titleInput.value || !self.txtInput.value){
                    alert('请输入标题和文字');
                    return;
                }
                if(!self.note.parent){
                    saveNote.execute({
                        txt: self.txtInput.value,
                        title: self.titleInput.value
                    });
                }else{
                    saveNote.execute({
                        txt: self.txtInput.value,
                        title: self.titleInput.value,
                        parent: self.note._id
                    });
                }
            };
            self.cancel = function(){
                self.init();
            };
            self.footerCmds = [
                {
                    name: '保存',
                    method: self.save
                },
                {
                    name: '取消',
                    method: self.cancel
                }
            ];
            self.init = function(){
                self.note = {
                    title: null,
                    comments: null,
                    crtOn: null,
                    _id: null
                };
                self.txtInput.value = '';
                self.titleInput.value = '';
                wx.onMenuShareTimeline({
                    title: '测试分享主题',
                    link: getLink(),
                    imgUrl: '',
                    success: function(){

                    },
                    cancel: function(){

                    }
                });
                function getLink(){
                }
            };
            function onLoadNote(data){
                console.log(data)
                if(data){
                    self.note = data;
                }
                self.trigger('ready', false);
                self.trigger('view-route-to');
                self.update();
            }
            function onSaveNote(data){
                if(data){
                    self.tmpNodes.push(data);
//                    if(data.parent==='root'){
//                        self.note = data;
//                    }else{
//                        self && !self.note.mates && (self.note.mates = []);
//                        self.note.mates.push(data)
//                    }
                }
                self.txtInput.value = '';
                self.update();
            }
            this.on('mount', function(){
                loadNote.onDone(onLoadNote);
                saveNote.onDone(onSaveNote);
            });
            this.on('unmount', function(){
                loadNote.offDone(onLoadNote);
                saveNote.offDone(onSaveNote);
            });
            this.on('open', function(options){
                self.init();
                try{
                    self.note._id = window.location.pathname.match(/_(\w+)/g)[0].substr(1);
                    console.log(self.note._id)
                }catch(e){
                    alert('无效的链接');
                }
                console.info('tag note new is opening');
                 loadNote.execute({
                    noteId: self.note._id
                });
            });

            this.on('leave', function(){
                self.mask = true;
                self.update();
            });

            this.on('reenter', function(){
                self.mask = false;
                self.update();
            });

            this.on('refresh', function(){
                console.info('tag group index is refreshing');
                //_refresh();
            });
        </script>
    </div>
</note-edit>