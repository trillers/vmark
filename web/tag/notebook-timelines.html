<notebook-timelines>
    <div id="shareMask" class="mask" if="{currentState === 'share'}" style="z-index: 5;height: {window.innerHeight + 'px'}"></div>
    <div class="timeline_container" if="{!hidden}">
        <notebook-timeline each="{note in opts.notebooks}" if="{parent.opts.latestnotebook._id === note._id}" notebook="{note}" latest="{parent.opts.latestnotebook}" mode="{parent.currentState}" shares="{parent.shares}"></notebook-timeline>
        <div class="btn_group" style="position: fixed; top: {300}px">
            <div id="prev_page_btn" onclick="{onPrevPageClick}" class="route_btn" style="float:left">上</div>
            <div id="next_page_btn" onclick="{onNextPageClick}" class="route_btn" style="float: right">下</div>
        </div>
        <div class="share_btn" onclick="{openShareMode}">
            享
        </div>
        <note-confirm></note-confirm>
    </div>
    <style>
        .mask{
            width: 100%;
            position: fixed;
            top: 0px;
            left: 0px;
            z-index: 5;
            background: black;
            opacity: 0.2;
        }
        .share_btn{
            position: fixed;
            bottom: 250px;
            right: 0px;
            width: 40px;
            height: 40px;
            background: red;
            z-index: 4;
        }
        .timeline_container{
            overflow: hidden;
        }
        .btn_group{
            width: 100%;
            position: fixed;
            z-index: 4;
        }
        .route_btn{
            width:40px;
            height: 40px;
            background: red;
        }
    </style>
    <script>
        var self = this;
        var updateLatestNotebook = domain.action('updateLatestNotebook');
        var addShareNotePage = domain.action('addShareNotePage');

        self.hidden = true;
        self.currentState = 'view';
        self.shares = [];
        app.on('viewMode', function(e){
            self.trigger('viewMode');
            self.update({
                currentState: 'view',
                shares: []
            })
        });
        app.on('beginShare', function(){
            //todo page new
            if(!self.shares.length){
                return;
            }
            addShareNotePage.newInvocation({
                notes: self.shares,
                initiator: __page.user
            })
            .onDone(function(res){
                self.currentState = 'view';
                self.shares = [];
                riot.route('share/_' + res.pageNote._id);
            })
            .execute();
        });
        app.on('addNewNote', function(e){
            self.trigger('addNewNote');
        });
        app.on('shareToggle', function(note){
            var i = self.shares.indexOf(note);
            if(i>=0){
                self.shares.splice(i, 1);
            }else{
                self.shares.push(note);
            }
            self.update({shares: self.shares});
        });
        var routeToNotebook = function(index){
            if(!self.opts.notebooks[index]){
                return;
            }
            self.opts.latestnotebook = self.opts.notebooks[index];
            var notebookId = self.opts.latestnotebook._id;
            updateLatestNotebook.execute({
                notebookId: notebookId
            })
            .onDone(function(){
                riot.route('timeline/_' + notebookId);
            })
        };
        self.onPrevPageClick = function(e){
            var currentIndex = self.opts.notebooks.map(function(notebook){return notebook._id}).indexOf(self.opts.latestnotebook._id);
            routeToNotebook(currentIndex-1);
        };
        self.onNextPageClick = function(e){
            var currentIndex = self.opts.notebooks.map(function(notebook){return notebook._id}).indexOf(self.opts.latestnotebook._id);
            routeToNotebook(currentIndex+1);
        };
        self.on('mount', function(){
        });
        self.on('open', function(){
            try{
                var notebook = self.opts.notebooks.filter(function(notebook){
                    return notebook._id === window.location.hash.split('_')[1]
                })[0];
                routeToNotebook(self.opts.notebooks.indexOf(notebook));
            }catch(e){
                console.error(e);
            }
            self.trigger('ready')
        });
        self.openShareMode = function(){
            if(!self.opts.latestnotebook
                || !self.opts.latestnotebook.mates
                || !self.opts.latestnotebook.mates.length
                || !self.opts.latestnotebook.mates.filter(function(note){
                        return note._id
                    }).length
            ){
                alert('请添加一条笔记先');
                return;
            }
            self.currentState='share';
        }
    </script>
</notebook-timelines>