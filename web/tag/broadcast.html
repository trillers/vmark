<broadcast>
    <div if="{!hidden}">
        <div if="{tip}" class="alert {addClass}" style="margin-top: -5px; float: left; width: 100%; text-align: center; margin-bottom: 0; position: absolute; z-index: 9999">
            <strong>{tipInfo}</strong>
        </div>
        <div class="container" style="width: 100%; margin-left: 0; margin-right: 0; padding-left: 0; padding-right: 0">
            <div class="row-fluid">
                <div class="col-md-4 col-xs-4 col-sm-4" style="padding-right: 0; padding-left: 0; margin-top: -5px; width: 30%">
                    <div class="well sidebar-nav" style="padding-top: 0; padding-right: 0; padding-left: 0;height: 48em; background-color:  #222; border: 1px solid #080808; overflow: scroll; border-radius: 0">
                        <div if="{!broadcastHistory.length}">
                            <ul style="padding: 0; margin: 0; list-style-type: none">
                                <li style="margin-bottom: 3px; padding: 25px 20px; background-color: #333; cursor: pointer; text-align: center">
                                    <span style="color: white">暂无群发纪录</span>
                                </li>
                            </ul>
                        </div>
                        <div if="{broadcastHistory.length}">
                            <ul style="padding: 0; margin: 0; list-style-type: none">
                                <li each="{broadcastHistory}" style="margin-bottom: 3px; padding: 5px 5px 5px 10px; background-color: #333; cursor: pointer; color: white">
                                    <div if="{contentType == 'image'}" style="height: 100%; width: 100%">
                                        <div style="display: -webkit-inline-box; width: 60%;">
                                            <img style="height: 5em" riot-src="{contentType == 'image' && media_id && parent.api + '/file/?media_id=' + media_id}" alt=""/>
                                        </div>

                                        <div style="font-size: 0.5em; height: 6em; text-align: right; float:right; line-height: 6em; width: 38%">{parent.formatDate(crtOn)}</div>
                                    </div>
                                    <div  if="{contentType == 'text'}" style="height: 100%; width: 100%">
                                        <div style="display: -webkit-inline-box; padding: 5px; height: 6em;overflow: hidden; width: 60%; font-size: 0.5em">{content}</div>
                                        <div style="font-size: 0.5em; height: 6em; line-height: 6em; float:right; text-align: right; width: 38%">{parent.formatDate(crtOn)}</div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div><!--/.well -->
                </div><!--/span-->
                <div class="col-md-8 col-xs-8 col-sm-8" style="padding-right: 1px; padding-left: 0; margin-top: -5px;  width: 70%">
                    <div class="jumbotron" style="height: 48em; border-radius: 0">
                        <div id="broadcast">

                            <div class="panel panel-default" id="img_prew" style="display:none; margin-bottom: 5px">
                                <table class="table table-bordered" style="text-align: center; vertical-align: middle;">
                                    <tbody>
                                    <tr>
                                        <td rowspan="3">
                                            <img src="{img_url}" alt="" style="height: 9em;"/></td>
                                        <td>文件名</td>
                                        <td>{img_name}</td>
                                    </tr>
                                    <tr>
                                        <td>文件大小</td>
                                        <td>{img_size}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2">
                                            <input class="btn btn-default" type="button"  style="margin-right: 50px" value="取消" onclick="{cancel_send_img}"/>
                                            <input class="btn btn-success" type="button" value="发送" onclick="{send_img}"/>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="choose_img" style="margin-left: 5px">
                                <span class='btn_addPic glyphicon glyphicon-picture' href="javascript:void(0);"><input id="img_file"  type="file"  class='filePrew' class="glyphicon glyphicon-picture" multiple="multiple" accept="image/bmp, image/jpg, image/jpeg, image/gif, image/png" onchange="{previewImg}"/></span>
                            </div>
                            <textarea id="broadcastMsg" style="margin-top: 5px;" class="form-control" rows="3"></textarea>
                            <button id="send" type="button" onclick="{broadcast}" style="margin-left: 83%; margin-top: 1em; width: 7em; margin-right: 1em; margin-bottom: 1em;" class="btn btn-success">发送</button>
                        </div>
                    </div>
                </div><!--/span-->
            </div><!--/row-->
        </div><!--/container-->

        <style scoped>
            .btn_addPic{
                display: block;
                position: relative;
                font-size: 35px;
                width: 38px;
                height: 38px;
                overflow: hidden;
                cursor: pointer;
                text-align: center;
            }
            .filePrew {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 38px;
                height: 38px;
                cursor: pointer;
                font-size: 100px; /* 增大不同浏览器的可点击区域 */
                opacity: 0; /* 实现的关键点 */
                filter:alpha(opacity=0);/* 兼容IE */
            }
        </style>

        <script>
            this.app = this.opts.app; //keep spa object
            var self = nest.presentable(this);
            self.env = (__app.settings.env.NODE_ENV=="production")?"public":"web";
            self.api =  __app.settings.api.url;
            self.botId = __page.bot.customId;
            self.broadcastHistory = [];
            self.tip = false;
            self.tipInfo = "";

            var broadcastTxt = domain.action('broadcastTxt');
            var broadcastImg = domain.action('broadcastImg');
            var loadBroadcastHistory = domain.action('loadBroadcastHistory')

            var onBroadcastTxt = function(data){
                $('#send').attr('disabled', false);
                if(data.success){
                    $('#broadcastMsg').val('');
                    self.broadcastHistory.unshift(data.msg);
                    self.update();
                    tipShow('success', '群发成功');
                }else{
                    tipShow('error', '群发失败');
                }
            }

            var onBroadcastImg = function(data){
                if(data.success){
                    $('#img_file').val('');
                    self.broadcastHistory.unshift(data.msg);
                    self.update();
                    tipShow('success', '群发图片成功');
                }else{
                    tipShow('error', '群发图片失败');
                }
            }

            var onLoadBroadcastHistory = function(data){
                self.broadcastHistory = data.history;
                self.update();
            }

            this.on('mount', function(){
                console.info('tag broadcast index is mounted');
                broadcastTxt.onDone(onBroadcastTxt);
                broadcastImg.onDone(onBroadcastImg);
                loadBroadcastHistory.onDone(onLoadBroadcastHistory);
            });
            this.on('unmount', function(){
                console.info('tag broadcast index is unmounted');
                broadcastTxt.offDone(onBroadcastTxt);
                broadcastImg.offDone(onBroadcastImg);
                loadBroadcastHistory.offDone(onLoadBroadcastHistory);
            });
            this.on('open', function(options){
                console.info('tag broadcast index is opening');
                self.trigger('ready', false);
                self.trigger('view-route-to');
                loadBroadcastHistory.execute(self.botId);
            });

            this.on('leave', function(){
                self.mask = true;
                self.update();
            });

            this.on('reenter', function(){
                self.mask = false;
                self.update();
            });

            this.on('refresh', function(){
                console.info('tag broadcast index is refreshing');
                //_refresh();
            });

            function tipShow(type, msg){
                var addClass = '';
                if(type === 'success'){
                    addClass = 'alert-success';
                }
                if(type === 'error'){
                    addClass = 'alert-danger';
                }
                if(type === 'info'){
                    addClass = 'alert-info';
                }
                if(type === 'warning'){
                    addClass = 'alert-warning';
                }
                self.update({tip: true, tipInfo: msg, addClass: addClass});
                setTimeout(function(){
                    self.update({tip: false, tipInfo: '', addClass: ''});
                }, 1000);
            }

            self.formatDate = function(date){
                var dateStr = new Date(date).toLocaleString();
                return dateStr.replace(/\//g, '-');
            }

            previewImg(e){
                var file = e.target.files[0];
                self.img_size = file.size/1000 + 'KB';
                self.img_name = file.name;
                var reader = new FileReader();
                reader.onload = function(data){
                    self.img_url = data.target.result;
                    self.update();
                    $('#img_prew').show();
                }
                reader.readAsDataURL(file);
            }

            cancel_send_img(e){
                $('#img_prew').hide();
            }

            send_img(e){
                var formData = new FormData();
                var files = $('#img_file')[0].files;
                formData.append('file', files[0]);
                $.ajax({
                    url : self.api + '/file/upload',
                    type : 'POST',
                    data : formData,
                    processData : false,
                    contentType : false,
                    success : function(responseStr) {
                        $('#img_prew').hide();
                        var data = {
                            botId: self.botId,
                            media_id: responseStr.media_id
                        }
                        broadcastImg.execute(data);
                    },
                    error : function(responseStr) {
                        console.error("失败:" + JSON.stringify(responseStr));
                    }
                });
            }

            broadcast(e){
                e.preventUpdate = true;
                var msg = $('#broadcastMsg').val().trim();
                if(msg.length > 0) {
                    var data = {
                        botId: self.botId,
                        msg: msg
                    }
                    broadcastTxt.execute(data);
                    $(e.currentTarget).attr('disabled', true);
                }else{
                    tipShow('warning', '发送内容不能为空');
                }
            }
        </script>
    </div>
</broadcast>