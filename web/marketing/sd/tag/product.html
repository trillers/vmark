<product>
    <ul>
        <li>{product.name}</li>
        <li>{product.slogan}</li>
        <li>{product.listPrice}</li>
        <li>{product.desc}</li>
        <li>{product.details}</li>

    </ul>
    <div>
        <input type="button" value="预约" onclick="{appointment}">
    </div>
    <div id="form" if="{formShow}" >
        <div id="bg" onclick="{cancelAppointment}"></div>
        <div id="info">
            <input name="telephone" type="text" placeholder="请输入电话号码">
            <input type="button" value="提交" onclick="{onSubmit}">
            <input type="button" value="取消" onclick="{cancelAppointment}">
        </div>
    </div>
    <style scoped>
        #bg{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99;
        }
        #info{
            position: fixed;
            top: 200px;
            left: 0;
            width: 100%;
            height: 200px;
            text-align: center;
            z-index: 100;
        }
    </style>
    <script>
        'use strict'
        this.mixin('dispatcher');

        let self = this;
        self.id = this.opts.id;
        self.media = this.opts.media;

        self.on('mount', function(opts) {
            self.dispatch(actions.productActions.loadProduct(self.id));
        })

        self.on('loadProduct', function(data){
            self.update({product: data.course});
        })

        self.on('addBespeak', function(res) {
            if(!res.error){
                alert('预约成功');
                self.update({formShow: false});
                return;
            }
            console.error(res.error);
        })

        self.appointment = function(e){
            if(self.isAnonymous()){
                return self.goToAuthorize();
            }
            self.update({formShow: true});
        }

        self.cancelAppointment = function(e) {
            self.update({formShow: false});
        }
        self.isAnonymous = function() {
            return !__page.user || !__page.user.status || __page.user.status === __app.enums.TenantUserStatus.names.BaseInfo;
        }

        self.goToAuthorize = function(e){
            var getUserInfoUrl = '/auth/' + __page.user.wechatId + '/authorize?';
            getUserInfoUrl += 'route=get_user_info&returnUrl='+location.href;
            location.href = getUserInfoUrl;
        }

        self.onSubmit = function(e){
            if(self.telephone.value.trim() === ""){
                return;
            }
            self.dispatch(actions.addBespeak({
                user: __page.user,
                product: self.product,
                media: self.media,
                telephone: self.telephone.value.trim()
            }));
        }
    </script>
</product>